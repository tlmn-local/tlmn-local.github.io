<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ä»Šæ—¥æ˜æœˆå¤œ</title><link>https://tlmn-local.github.io/</link><description>Recent content on ä»Šæ—¥æ˜æœˆå¤œ</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Mon, 10 Oct 2022 00:40:48 +0800</lastBuildDate><atom:link href="https://tlmn-local.github.io/atom.xml" rel="self" type="application/rss+xml"/><item><title>å°æŠ€å·§ MAC ä¸‹çš„ DNS é…ç½®</title><link>https://tlmn-local.github.io/2022/10/10/%E5%B0%8F%E6%8A%80%E5%B7%A7-mac-%E4%B8%8B%E7%9A%84-dns-%E9%85%8D%E7%BD%AE/</link><pubDate>Mon, 10 Oct 2022 00:40:48 +0800</pubDate><guid>https://tlmn-local.github.io/2022/10/10/%E5%B0%8F%E6%8A%80%E5%B7%A7-mac-%E4%B8%8B%E7%9A%84-dns-%E9%85%8D%E7%BD%AE/</guid><description>&lt;p>åœ¨å­¦ä¹ å†…ç½‘æ¸—é€æˆ–å®æˆ˜ä¸­å¿…ç„¶éœ€è¦é…ç½®æœºå™¨çš„ DNS ä»¥å®ç°è®¿é—®åŸŸç¯å¢ƒï¼Œè¿™é‡Œæä¾›ä¸¤ä¸ªåœ¨ MacOS ä¸­é…ç½® DNS çš„æ–¹æ¡ˆã€‚&lt;/p>
&lt;p>æ–¹æ¡ˆä¸€ï¼šé€šè¿‡ WIFI GUI è¿›è¡Œé…ç½®ï¼Œåœ¨ç³»ç»Ÿåå¥½è®¾ç½® &amp;ndash;&amp;gt; ç½‘ç»œ &amp;ndash;&amp;gt; é«˜çº§ &amp;ndash;&amp;gt; DNS ä¸­å¯é…ç½® DNS æœåŠ¡å™¨ä¸æ£€ç´¢åŸŸã€‚&lt;/p>
&lt;img src="https://tva1.sinaimg.cn/large/008vxvgGgy1h6zibgnbzsj30vv0u0jsz.jpg"/>
&lt;p>ä½†è¿™æ ·çš„é…ç½®ä¸ WIFI ç»‘å®šï¼ŒåŒæ—¶å¦‚æœåªé…äº†ä¸€ä¸ª DNS æœåŠ¡å™¨å®¹æ˜“å‡ºç°å½“å®éªŒç¯å¢ƒå…³é—­æ—¶ä¸å¯è”ç½‘çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>æ–¹æ¡ˆäºŒï¼šæ‰‹åŠ¨åˆ›å»º &lt;code>/etc/resolver&lt;/code> ç›®å½•ï¼Œå¹¶ä»¥åŸŸåä¸ºåç§°åˆ›å»ºæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹ä¸­åŒ…å« DNS æœåŠ¡å™¨ã€‚&lt;/p>
&lt;img src="https://tva1.sinaimg.cn/large/008vxvgGgy1h6zie38pmpj317o0d4gnf.jpg"/>
&lt;p>è¿™ç§é…ç½®æ–¹æ¡ˆèƒ½å¤ŸçœŸæ­£æ„ä¹‰ä¸Šå®ç°å¯¹æŸä¸ªåŸŸåï¼ˆåŠå…¶å­åŸŸåï¼‰ä½¿ç”¨ä¸“ç”¨çš„ DNS æœåŠ¡å™¨ï¼Œå³ä½¿ DNS æœåŠ¡å™¨å…³æœºä¹Ÿä¸å½±å“æ­£å¸¸ä¸Šç½‘ã€‚&lt;/p></description></item><item><title>Kerberos Protocol</title><link>https://tlmn-local.github.io/2022/03/24/kerberos-protocol/</link><pubDate>Thu, 24 Mar 2022 17:59:34 +0800</pubDate><guid>https://tlmn-local.github.io/2022/03/24/kerberos-protocol/</guid><description>&lt;h1 id="æ¦‚è¿°">æ¦‚è¿°&lt;/h1>
&lt;p>Kerberos æä¾›äº†ä¸€ç§åœ¨ä¸å—ä¿æŠ¤ç½‘ç»œä¸ŠéªŒè¯ä¸»ä½“ï¼ˆç”¨æˆ·æˆ–ç½‘ç»œæœåŠ¡å™¨ï¼‰èº«ä»½çš„æ–¹æ³•ï¼Œè¿™ç§è®¤è¯æ–¹å¼ä¸ä¾èµ–äºæ“ä½œç³»ç»Ÿã€ä¸»æœºä¹‹é—´çš„ç›¸äº’ä¿¡ä»»ï¼Œå¹¶ä¸”å‡è®¾èº«ä»½è®¤è¯èƒ½å¤Ÿåœ¨æ•°æ®åŒ…æ²¿ç½‘ç»œä¼ é€’è¿‡ç¨‹ä¸­å¯éšæ„è¯»å–ã€ç¯¡æ”¹çš„æƒ…å†µä¸‹ä¸å—å½±å“ã€‚&lt;/p>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½œä¸ºä¸€ç§èº«ä»½éªŒè¯æœåŠ¡ï¼ŒKerberos æä¾›äº†ä¸€ç§éªŒè¯ç½‘ç»œä¸Šä¸»ä½“èº«ä»½çš„æ–¹æ³•ï¼Œä¸»è¦æ˜¯ä½œä¸ºæˆæƒè¿‡ç¨‹ä¸­çš„ç¬¬ä¸€æ­¥ï¼Œç¡®è®¤å®¢æˆ·ç«¯çš„èº«ä»½æ˜¯å¦æ­£ç¡®ï¼Œ&lt;strong>Kerberos æœ¬èº«å¹¶ä¸æä¾›æˆæƒ&lt;/strong>ã€‚&lt;/p>
&lt;p>ä¸ºäº†ä¿è¯è®¤è¯åœ¨å®‰å…¨çš„æƒ…å†µä¸‹é¡ºåˆ©è¿›è¡Œï¼ŒKerberos å¯¹å…¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œçš„ç¯å¢ƒæœ‰ä¸€å®šè¦æ±‚ï¼š&lt;/p>
&lt;ul>
&lt;li>ä¸å­˜åœ¨æ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆDOSï¼‰&lt;/li>
&lt;li>å¯†é’¥å¿…é¡»ä¿å¯†ï¼ˆæ”»å‡»è€…åœ¨æ— å¯†é’¥çš„æƒ…å†µä¸‹æ— æ³•é¡ºåˆ©é€šè¿‡è®¤è¯ï¼‰&lt;/li>
&lt;li>ç”¨æˆ·çš„å¯†ç å¿…é¡»è¶³å¤Ÿå¼ºå¤§&lt;/li>
&lt;li>ç½‘ç»œä¸Šçš„ä¸»æœºé—´éœ€æœ‰ä¸€ä¸ªä¸å…¶å®ƒä¸»æœºæ—¶é—´çš„æ¾æ•£åŒæ­¥æ—¶é’Ÿï¼Œå¹¶ä¸”æ—¶é’ŸåŒæ­¥å¿…é¡»èƒ½å¤Ÿä¿è¯å®‰å…¨&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>æ³¨ï¼šæœ¬æ–‡ä»…ä»‹ç» Kerberos åœ¨ Microsoft Windows Domain ä¸­çš„ä½¿ç”¨æƒ…å†µï¼ŒUnix ä¸‹çš„ä½¿ç”¨åœºæ™¯ä¸ä¼šåœ¨æœ¬æ–‡ä¸­è¿›è¡Œä»‹ç»ã€‚&lt;/strong>&lt;/p>
&lt;h1 id="ç»„ä»¶">ç»„ä»¶&lt;/h1>
&lt;p>åœ¨ Kerberos èº«ä»½è®¤è¯è¿‡ç¨‹ä¸­æœ‰å¤šæ–¹å‚ä¸ï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªè®¤è¯ä¸»ä½“ã€å¯†é’¥å’ŒæœåŠ¡ï¼Œä¸ºäº†é¿å…åç»­å®é™…åˆ†æåè®®æµç¨‹æ—¶è¢«ç»•æ™•ï¼Œæˆ‘å†³å®šå…ˆä»‹ç»æ¯ä¸ªå‚ä¸è®¤è¯çš„ç»„ä»¶ã€‚&lt;/p>
&lt;h2 id="ä¸»ä½“">ä¸»ä½“&lt;/h2>
&lt;p>ä¸å¸¸è§„çš„è®¤è¯ä¸»ä½“ä¸åŒï¼ŒKerberos ä¸ä»…åŒ…å«å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ï¼Œè¿˜åŒ…å«äº†ä¸€ä¸ªå—ä¿¡ä»»çš„ç¬¬ä¸‰æ–¹ï¼Œå®Œæ•´çš„ä¸»ä½“åå•å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>å®¢æˆ·ç«¯ï¼ˆæƒ³è¦è°ƒç”¨æŸé¡¹æœåŠ¡çš„ç”¨æˆ·ï¼‰&lt;/li>
&lt;li>æä¾›æœåŠ¡çš„åº”ç”¨æœåŠ¡å™¨&lt;/li>
&lt;li>&lt;strong>KDC&lt;/strong> (Key Distribution Center)ï¼ŒKerberos çš„ä¸»è¦æœåŠ¡ï¼Œè´Ÿè´£ç­¾å‘ç¥¨è¯ï¼Œé€šå¸¸å®‰è£…åœ¨ DC ä¸Šï¼Œå…¶ä¸­åŒ…å« AS æœåŠ¡ä¸ TGS æœåŠ¡&lt;/li>
&lt;/ul>
&lt;h2 id="å¯†é’¥">å¯†é’¥&lt;/h2>
&lt;p>Kerberos è®¤è¯æµç¨‹ä¸­æ¶‰åŠåˆ°äº†è®¸å¤šæ•°æ®çš„åŠ è§£å¯†ï¼Œå…¶ä¸­ä½¿ç”¨åˆ°çš„å¯†é’¥ç±»å‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>ç”¨æˆ·å¯†é’¥ï¼ˆè®¤è¯ç”¨æˆ·çš„å“ˆå¸Œï¼‰&lt;/li>
&lt;li>æœåŠ¡å¯†é’¥ï¼ˆæœåŠ¡æ‰€å±è€…çš„å“ˆå¸Œï¼‰&lt;/li>
&lt;li>æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹éœ€è¦ç”¨åˆ°çš„å­å¯†é’¥&lt;/li>
&lt;li>krbtgt å¯†é’¥ï¼ˆåŸŸè´¦æˆ· krbtgt çš„å“ˆå¸Œï¼‰&lt;/li>
&lt;li>ç”¨æˆ·ä¸æœåŠ¡é€šä¿¡æ—¶ä½¿ç”¨çš„æœåŠ¡é€šä¿¡å¯†é’¥&lt;/li>
&lt;li>ç”¨æˆ·ä¸ KDC é€šä¿¡æ—¶ä½¿ç”¨çš„ KDC é€šä¿¡å¯†é’¥&lt;/li>
&lt;/ul>
&lt;h2 id="ç¥¨è¯">ç¥¨è¯&lt;/h2>
&lt;p>Kerberos åŸºäºç¥¨è¯å®ç°å®Œæ•´çš„èº«ä»½è®¤è¯åŠŸèƒ½ï¼Œå…¶ä¸­ä¸»è¦åŒ…å«ä¸¤ç§ç±»å‹çš„ç¥¨è¯ï¼š&lt;/p>
&lt;ul>
&lt;li>TGTï¼ˆTicket Granting Ticketï¼‰æ˜¯æäº¤ç»™ KDC ä»¥è¯·æ±‚ TGS çš„ç¥¨è¯ï¼Œ&lt;strong>ä½¿ç”¨ krbtgt å¯†é’¥åŠ å¯†&lt;/strong>&lt;/li>
&lt;li>ST ï¼ˆService Ticketï¼‰æ˜¯ç”¨æˆ·å¯ç”¨äºå¯¹æœåŠ¡è¿›è¡Œèº«ä»½éªŒè¯çš„ç¥¨è¯ï¼Œ&lt;strong>ä½¿ç”¨æœåŠ¡å¯†é’¥åŠ å¯†&lt;/strong>&lt;/li>
&lt;/ul>
&lt;h2 id="æ¶ˆæ¯">æ¶ˆæ¯&lt;/h2>
&lt;p>Kerberos çš„é€šä¿¡è¿‡ç¨‹ä¸­ä½¿ç”¨äº†ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼ˆ&lt;strong>AS å’Œ TGS æœ‰æ—¶ä¹Ÿä»¥ KDC ä½œä¸ºç»Ÿç§°ï¼Œä¸‹é¢çš„æè¿°ä¸­å¯¹å…¶è¿›è¡Œäº†ç»†åˆ†&lt;/strong>ï¼‰ï¼š&lt;/p>
&lt;ul>
&lt;li>KRB_AS_REQ : å®¢æˆ·ç«¯å‘ AS éªŒè¯èº«ä»½ä»¥è·å– TGT&lt;/li>
&lt;li>KRB_AS_REP : AS å°† TGT è¿”å›ç»™å®¢æˆ·ç«¯&lt;/li>
&lt;li>KRB_TGS_REQ : å®¢æˆ·ç«¯ä½¿ç”¨ TGT å‘ TGS è¯·æ±‚ ST&lt;/li>
&lt;li>KRB_TGS_REP : TGS å°† ST è¿”å›ç»™å®¢æˆ·ç«¯&lt;/li>
&lt;li>KRB_AP_REQ : å®¢æˆ·ç«¯ä½¿ç”¨ ST å‘æœåŠ¡éªŒè¯èº«ä»½&lt;/li>
&lt;li>KRB_AP_REP : æœåŠ¡å‘å®¢æˆ·ç«¯éªŒè¯èº«ä»½æˆ–è¿”å›é”™è¯¯ä¿¡æ¯&lt;/li>
&lt;li>KRB_ERROR : è¿”å›åœ¨ Kerberos è®¤è¯è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯&lt;/li>
&lt;/ul>
&lt;h2 id="ç»“æ„">ç»“æ„&lt;/h2>
&lt;p>Kerberos åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ä¼ é€’çš„æ¶ˆæ¯å¤§éƒ¨åˆ†å…·æœ‰å›ºå®šç»“æ„ï¼Œæ­¤å¤„å…ˆåˆ—å‡ºéƒ¨åˆ†é€šä¿¡è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°çš„ç»“æ„ï¼Œä»¥ä¾¿åç»­èƒ½å¤Ÿå¯¹è®¤è¯æµç¨‹æœ‰æ›´ä¸ºè¯¦ç»†çš„è®¤çŸ¥ã€‚&lt;/p>
&lt;h3 id="krb_kdc_req">KRB_KDC_REQ&lt;/h3>
&lt;p>æ­¤ç»“æ„æ˜¯ KRB_AS_REQ ä¸ KRB_TGS_REQ æ‰€ä½¿ç”¨çš„å®Œæ•´ç»“æ„ï¼Œä¸¤ä¸ªæ¶ˆæ¯å…±ç”¨ä¸€ä¸ªç»“æ„ä½“ï¼Œå¹¶åˆ†åˆ«ä½¿ç”¨æ­¤ç»“æ„ä½“ä¸­çš„éƒ¨åˆ†å­—æ®µã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">AS-REQ ::= [APPLICATION 10] KDC-REQ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TGS-REQ ::= [APPLICATION 12] KDC-REQ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">KDC-REQ ::= SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- NOTE: first tag is [1], not [0]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pvno [1] INTEGER (5) ,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> msg-type [2] INTEGER (10 -- AS -- | 12 -- TGS --),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> padata [3] SEQUENCE OF PA-DATA OPTIONAL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- NOTE: not empty --,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> req-body [4] KDC-REQ-BODY
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">KDC-REQ-BODY ::= SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kdc-options [0] KDCOptions,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cname [1] PrincipalName OPTIONAL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- Used only in AS-REQ --,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> realm [2] Realm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- Server&amp;#39;s realm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- Also client&amp;#39;s in AS-REQ --,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sname [3] PrincipalName OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> from [4] KerberosTime OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> till [5] KerberosTime,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rtime [6] KerberosTime OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nonce [7] UInt32,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> etype [8] SEQUENCE OF Int32 -- EncryptionType
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- in preference order --,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> addresses [9] HostAddresses OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> enc-authorization-data [10] EncryptedData OPTIONAL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- AuthorizationData --,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> additional-tickets [11] SEQUENCE OF Ticket OPTIONAL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- NOTE: not empty
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">KDCOptions ::= KerberosFlags
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- reserved(0),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- forwardable(1),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- forwarded(2),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- proxiable(3),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- proxy(4),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- allow-postdate(5),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- postdated(6),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- unused7(7),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- renewable(8),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- unused9(9),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- unused10(10),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- opt-hardware-auth(11),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- unused12(12),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- unused13(13),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-- 15 is reserved for canonicalize
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- unused15(15),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-- 26 was unused in 1510
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- disable-transited-check(26),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- renewable-ok(27),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- enc-tkt-in-skey(28),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- renew(30),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- validate(31)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- opt-hardware-auth(11),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- unused12(12),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- unused13(13),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-- 15 is reserved for canonicalize
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- unused15(15),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-- 26 was unused in 1510
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- disable-transited-check(26),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- renewable-ok(27),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- enc-tkt-in-skey(28),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- renew(30),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- validate(31)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>
&lt;p>pvno : å½“å‰é€šä¿¡æ‰€ä½¿ç”¨çš„ Kerberos ç‰ˆæœ¬å·&lt;/p>
&lt;/li>
&lt;li>
&lt;p>msg-type : å½“å‰æ¶ˆæ¯ç±»å‹ï¼ˆAS || TGSï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>padata (PreAuthentication Data) : ç”¨äºå­˜æ”¾æ¶ˆæ¯ä¸­çš„è®¤è¯æ•°æ®&lt;/p>
&lt;/li>
&lt;li>
&lt;p>req-body ï¼šè¯·æ±‚ä½“ç»“æ„&lt;/p>
&lt;ul>
&lt;li>kdc-options : é€šä¿¡æ—¶è®¾ç½®çš„ Flag&lt;/li>
&lt;li>cname : è®¤è¯ç”¨æˆ·åç§°&lt;/li>
&lt;li>realm : è®¤è¯å®¢æˆ·ç«¯æ‰€å¤„åŸŸåï¼ˆåœ¨ KRB_TGS_REQ ä¸­è¡¨ç¤ºè°ƒç”¨æœåŠ¡ç«¯æ‰€å¤„åŸŸï¼‰&lt;/li>
&lt;li>sname : ä¸å½“å‰è°ƒç”¨æœåŠ¡ç»‘å®šçš„ SPN&lt;/li>
&lt;li>nonce : ç”±å®¢æˆ·ç«¯åˆ›å»ºçš„éšæœºæ•°ï¼Œç”¨äºéªŒè¯ KDC èº«ä»½ï¼Œé˜²æ­¢æ¶æ„æ”»å‡»&lt;/li>
&lt;li>etype : æ”¯æŒçš„åŠ å¯†å‡½æ•°&lt;/li>
&lt;li>address : å®¢æˆ·ç«¯ä¸»æœºå&lt;/li>
&lt;li>enc-authorization-data : åŠ å¯†çš„æˆæƒæ•°æ®&lt;/li>
&lt;li>additional-tickets : é™„åŠ ç¥¨è¯&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="krb_kdc_rep">KRB_KDC_REP&lt;/h3>
&lt;p>æ­¤ç»“æ„æ˜¯ KRB_AS_REP ä¸ KRB_TGS_REP æ‰€ä½¿ç”¨çš„ç»“æ„ä½“ï¼Œä¸¤ä¸ªæ¶ˆæ¯å…±ç”¨ä¸€ä¸ªç»“æ„ä½“ï¼Œå¹¶åˆ†åˆ«ä½¿ç”¨æ­¤ç»“æ„ä½“ä¸­çš„éƒ¨åˆ†å­—æ®µã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">AS-REP ::= [APPLICATION 11] KDC-REP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TGS-REP ::= [APPLICATION 13] KDC-REP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">KDC-REP ::= SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pvno [0] INTEGER (5),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> msg-type [1] INTEGER (11 -- AS -- | 13 -- TGS --),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> padata [2] SEQUENCE OF PA-DATA OPTIONAL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- NOTE: not empty --,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> crealm [3] Realm,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cname [4] PrincipalName,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ticket [5] Ticket,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> enc-part [6] EncryptedData
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- EncASRepPart or EncTGSRepPart,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- as appropriate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EncASRepPart ::= [APPLICATION 25] EncKDCRepPart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EncTGSRepPart ::= [APPLICATION 26] EncKDCRepPart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EncKDCRepPart ::= SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> key [0] EncryptionKey,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> last-req [1] LastReq,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nonce [2] UInt32,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> key-expiration [3] KerberosTime OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> flags [4] TicketFlags,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authtime [5] KerberosTime,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> starttime [6] KerberosTime OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> endtime [7] KerberosTime,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> renew-till [8] KerberosTime OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> srealm [9] Realm,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sname [10] PrincipalName,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> caddr [11] HostAddresses OPTIONAL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LastReq ::= SEQUENCE OF SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> lr-type [0] Int32,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> lr-value [1] KerberosTime
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>crealm : è®¤è¯å®¢æˆ·ç«¯æ‰€å¤„åŸŸå&lt;/li>
&lt;li>ticket : ä½¿ç”¨å¯†é’¥åŠ å¯†çš„ Ticket ç»“æ„ä½“&lt;/li>
&lt;li>enc-part : ä½¿ç”¨å¯†é’¥åŠ å¯†çš„ EncKDCRepPart ç»“æ„ä½“
&lt;ul>
&lt;li>key : ä¼šè¯å¯†é’¥&lt;/li>
&lt;li>nonce : å®¢æˆ·ç«¯ç”Ÿæˆçš„éšæœºæ•°&lt;/li>
&lt;li>key-expiration : ä¼šè¯å¯†é’¥åˆ°æœŸæ—¶é—´&lt;/li>
&lt;li>flags : ticket çš„éƒ¨åˆ†å±æ€§è®¾ç½®&lt;/li>
&lt;li>authtime : è®¤è¯æ—¶é—´&lt;/li>
&lt;li>starttime : ç¥¨è¯èµ·å§‹æœ‰æ•ˆæ—¶é—´&lt;/li>
&lt;li>endtime : ç¥¨è¯æ— æ•ˆæ—¶é—´&lt;/li>
&lt;li>srealm : æœåŠ¡ç«¯æ‰€å¤„åŸŸå&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="krb_ap_req">KRB_AP_REQ&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">AP-REQ ::= [APPLICATION 14] SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pvno [0] INTEGER (5),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> msg-type [1] INTEGER (14),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ap-options [2] APOptions,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ticket [3] Ticket,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authenticator [4] EncryptedData -- Authenticator
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">APOptions ::= KerberosFlags
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- reserved(0),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- use-session-key(1),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- mutual-required(2)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Authenticator ::= [APPLICATION 2] SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authenticator-vno [0] INTEGER (5),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> crealm [1] Realm,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cname [2] PrincipalName,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cksum [3] Checksum OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cusec [4] Microseconds,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ctime [5] KerberosTime,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> subkey [6] EncryptionKey OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> seq-number [7] UInt32 OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authorization-data [8] AuthorizationData OPTIONAL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>authenticator : ä½¿ç”¨å¯†é’¥åŠ å¯†çš„ Authenticator ç»“æ„ä½“
&lt;ul>
&lt;li>cksum : æ ¡éªŒå’Œ&lt;/li>
&lt;li>subkey : å­å¯†é’¥&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="krb_ap_rep">KRB_AP_REP&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">AP-REP ::= [APPLICATION 15] SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pvno [0] INTEGER (5),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> msg-type [1] INTEGER (15),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> enc-part [2] EncryptedData -- EncAPRepPart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EncAPRepPart ::= [APPLICATION 27] SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ctime [0] KerberosTime,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cusec [1] Microseconds,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> subkey [2] EncryptionKey OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> seq-number [3] UInt32 OPTIONAL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>enc-part : ä½¿ç”¨å¯†é’¥åŠ å¯†çš„ EncAPRepPart ç»“æ„ä½“&lt;/li>
&lt;/ul>
&lt;h3 id="ticket">Ticket&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Ticket ::= [APPLICATION 1] SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tkt-vno [0] INTEGER (5),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> realm [1] Realm,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sname [2] PrincipalName,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> enc-part [3] EncryptedData -- EncTicketPart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EncTicketPart ::= [APPLICATION 3] SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> flags [0] TicketFlags,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> key [1] EncryptionKey,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> crealm [2] Realm,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cname [3] PrincipalName,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> transited [4] TransitedEncoding,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authtime [5] KerberosTime,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> starttime [6] KerberosTime OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> endtime [7] KerberosTime,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> renew-till [8] KerberosTime OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> caddr [9] HostAddresses OPTIONAL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authorization-data [10] AuthorizationData OPTIONAL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TransitedEncoding ::= SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tr-type [0] Int32 -- must be registered --,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> contents [1] OCTET STRING
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TicketFlags ::= KerberosFlags
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- reserved(0),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- forwardable(1),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- forwarded(2),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- proxiable(3),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- proxy(4),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- may-postdate(5),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- postdated(6),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- invalid(7),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- renewable(8),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- initial(9),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- pre-authent(10),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- hw-authent(11),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- the following are new since 1510
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- transited-policy-checked(12),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- ok-as-delegate(13)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>enc-part : ä½¿ç”¨å¯†é’¥åŠ å¯†çš„ EncTicketPart ç»“æ„ä½“
&lt;ul>
&lt;li>key : ä¼šè¯å¯†é’¥&lt;/li>
&lt;li>crealm : ç¥¨è¯ä½œç”¨åŸŸå&lt;/li>
&lt;li>cname : ç¥¨è¯æ‰€å±ç”¨æˆ·å&lt;/li>
&lt;li>authorization-data : æ’å…¥åœ¨ç¥¨è¯ä¸­çš„æˆæƒæ•°æ®ï¼Œ&lt;strong>å¾®è½¯çš„å®ç°ä¸­æ’å…¥çš„æ˜¯ç”±å¯†é’¥åŠ å¯†çš„è®¤è¯ç”¨æˆ·ç‰¹æƒè¯ä¹¦&lt;/strong>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="authorizationdata">AuthorizationData&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">AuthorizationData ::= SEQUENCE OF SEQUENCE {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ad-type [0] Int32,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ad-data [1] OCTET STRING
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>ad-type : æˆæƒç±»å‹&lt;/li>
&lt;li>ad-data : æˆæƒæ•°æ®&lt;/li>
&lt;/ul>
&lt;h2 id="ç‰¹æƒè¯ä¹¦">ç‰¹æƒè¯ä¹¦&lt;/h2>
&lt;p>ç‰¹æƒè¯ä¹¦ï¼ˆPACï¼‰æ˜¯å¾®è½¯å¯¹ Kerberos è¿›è¡Œæ‰©å±•åå®ç°çš„ï¼Œå…¶åŒ…å«ç”¨æˆ·çš„æƒé™ï¼Œå¹¶ä½¿ç”¨ krbtgt å¯†é’¥è¿›è¡Œç­¾åï¼Œæœ€ç»ˆè¢«åŒ…å«åœ¨ KDC é¢å‘çš„ç¥¨è¯ä¸­ï¼ŒæœåŠ¡å¯ä»¥é€šè¿‡ä¸ KDC é€šä¿¡å¯¹ PAC è¿›è¡ŒéªŒè¯ï¼Œ&lt;strong>ä½†æ­¤å¤„åªä¼šæ£€æŸ¥ PAC æ˜¯å¦è¢«ç¯¡æ”¹ï¼Œè€Œä¸ä¼šæ£€æŸ¥å…¶ä¸­åŒ…å«çš„æƒé™æ˜¯å¦æ­£ç¡®ã€‚&lt;/strong>&lt;/p>
&lt;p>&lt;strong>æ³¨ï¼šç”¨æˆ·å¯åœ¨ KRB_AS_REQ çš„ padata ä¸­è®¾ç½® Flag è¡¨æ˜ä¸éœ€è¦åœ¨ Ticket ä¸­åŒ…å« PAC ã€‚&lt;/strong>&lt;/p>
&lt;h1 id="è®¤è¯æµç¨‹">è®¤è¯æµç¨‹&lt;/h1>
&lt;p>æœ¬ç« å°†é€šè¿‡æ¨¡æ‹Ÿ Kerberos è®¤è¯åœºæ™¯æ¥åˆ†æ Kerberos è®¤è¯ç»†èŠ‚ï¼Œå¼ºçƒˆå»ºè®®çœ‹å®Œ 0x01 ä¸­ç»„ä»¶çš„åˆ†æå†æ¥çœ‹è¿™ä¸€éƒ¨åˆ†ï¼Œèƒ½å¤Ÿæ›´åŠ ç›´è§‚çš„äº†è§£è®¤è¯ç»†èŠ‚ã€‚&lt;/p>
&lt;p>æŸæ¬¡å®Œæ•´çš„ Kerberos è®¤è¯æ‰€å‘å‡ºçš„æ¶ˆæ¯å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0l4d6h1gqj22ri09wn1o.jpg"
loading="lazy"
alt="image-20220324160913525"
>&lt;/p>
&lt;p>å…¶ä¸­ 192.168.10.36 ä½œä¸ºå®¢æˆ·ç«¯å‘ 192.168.10.35 è¯·æ±‚ SMB æœåŠ¡è°ƒç”¨ï¼Œ192.168.10.34 ä¸º DC æ‰€å± IPã€‚&lt;/p>
&lt;h2 id="krb_as_req">KRB_AS_REQ&lt;/h2>
&lt;p>æ­¤æ¶ˆæ¯ç”¨äºå‘ AS æœåŠ¡éªŒè¯èº«ä»½å¹¶è¯·æ±‚ TGT ï¼Œæœ‰ä¸¤ç§éªŒè¯æ¨¡å¼ï¼ŒåŒºåˆ«ä¸ºæ˜¯å¦ä½¿ç”¨äº†é¢„è®¤è¯æ¨¡å¼ã€‚ä¸ºäº†å®ç°å…¼å®¹ï¼ŒKerberos 5 ä¸­é»˜è®¤ä¼šå…ˆå‘é€ä¸€ä¸ªä¸å¸¦é¢„è®¤è¯æ•°æ®çš„ KRB_AS_REQ ï¼Œå¦‚æœè®¤è¯ç”¨æˆ·ä¸æ”¯æŒè¿™ç§è®¤è¯æ¨¡å¼åˆ™ KDC ä¼šé€šè¿‡ KRB_ERROR æ¶ˆæ¯è¿”å›å…·ä½“é”™è¯¯ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ä¼šå°†é¢„è®¤è¯æ•°æ®åŠ å…¥åˆ° KRB_AS_REQ ä¸­å†æ¬¡å‘é€è¯·æ±‚ã€‚&lt;/p>
&lt;p>ç”±äºä½¿ç”¨é¢„è®¤è¯æ•°æ®çš„æ˜¯è¾ƒä¸ºé€šç”¨çš„åœºæ™¯ï¼Œå› æ­¤æœ¬èŠ‚ç€é‡åˆ†æå®éªŒäº†é¢„è®¤è¯æ•°æ®çš„è®¤è¯æ¨¡å¼ï¼Œå¦å¤–ä¸€ç§ä¸ä½¿ç”¨é¢„è®¤è¯æ•°æ®çš„è®¤è¯æ¨¡å¼ç•™å¾…åç»­ Kerberos å®‰å…¨éšæ‚£ç« èŠ‚ä¸­å†è¿›è¡Œåˆ†æã€‚&lt;/p>
&lt;p>&lt;strong>åœ¨ä½¿ç”¨äº†é¢„è®¤è¯æ•°æ®çš„åœºæ™¯ä¸­ï¼Œå®¢æˆ·ç«¯é¦–å…ˆä¼šä½¿ç”¨ç”¨æˆ·å¯†é’¥åŠ å¯†ä¸€ä¸ªæ—¶é—´æˆ³å¹¶å°†å…¶åŠ å…¥åˆ° padata å­—æ®µä¸­ï¼Œä¸å…¶ä¸€åŒåŠ å…¥åˆ°è¿˜æœ‰ pA-PAC-REQUEST è¿™ä¸ªå±æ€§ï¼Œå‰è€…ä¸ºäº†å‘ KDC éªŒè¯èº«ä»½ï¼Œåè€…åˆ™æ˜¯è®¾ç½®æ˜¯å¦éœ€è¦åœ¨ Ticket ä¸­åŒ…å« PACã€‚&lt;/strong>&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0l4d47gr6j21zp0u0jwu.jpg"
loading="lazy"
alt="image-20220324161721347"
>&lt;/p>
&lt;h2 id="krb_as_rep">KRB_AS_REP&lt;/h2>
&lt;p>AS æœåŠ¡æ”¶åˆ° KRB_AS_REQ è¯·æ±‚åï¼Œé¦–å…ˆåœ¨æ´»åŠ¨ç›®å½•ä¸­æŸ¥æ‰¾è®¤è¯ç”¨æˆ·å¯¹åº”åˆ°å“ˆå¸Œå¹¶ä½¿ç”¨å…¶ä½œä¸ºå¯†é’¥è§£å¯† padata ä¸­çš„ pA-ENC-TIMESTAMPï¼Œå¦‚æœè§£å¯†å¤±è´¥åˆ™ä»£è¡¨è®¤è¯å¤±è´¥ï¼›è§£å¯†æˆåŠŸåè·å¾—ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œæ¥ç€ç”¨æœ¬åœ°æ—¶é—´ä¸æ—¶é—´æˆ³ç›¸å‡å¾—åˆ°ä¸€ä¸ªå·®å€¼ï¼Œå¦‚æœæ­¤å·®å€¼åœ¨å…è®¸èŒƒå›´å†…åˆ™è®¤è¯æˆåŠŸã€‚&lt;/p>
&lt;p>è®¤è¯æˆåŠŸåå°†ä¼šç”Ÿæˆä¸¤ä¸ªé‡è¦çš„ç»“æ„ä½“ï¼Œä¸€ä¸ªæ˜¯ TGT ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ EncKDCRepPart ï¼Œ&lt;strong>å‰è€…ä½¿ç”¨ krbtgt å¯†é’¥åŠ å¯†ï¼Œåè€…ä½¿ç”¨ç”¨æˆ·å¯†é’¥åŠ å¯†ï¼Œä¸¤ä¸ªç»“æ„ä½“å‡åŒ…å«ä¸€ä¸ªç›¸åŒçš„ KDC ä¼šè¯å¯†é’¥&lt;/strong>ï¼›å¦‚æœåœ¨ KRB_AS_REQ ä¸­ pA-PAC-REQUEST è®¾ä¸º true ï¼Œè¿˜ä¼šå°†ç”¨æˆ·çš„ PAC æ”¾ç½®åœ¨ TGT ä¸­ã€‚&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0l4d0t3toj222y0u0q8l.jpg"
loading="lazy"
alt="image-20220324162705486"
>&lt;/p>
&lt;h2 id="krb_tgs_req">KRB_TGS_REQ&lt;/h2>
&lt;p>å®¢æˆ·ç«¯æ”¶åˆ° KRB_AS_REP åï¼Œé¦–å…ˆä½¿ç”¨ç”¨æˆ·å¯†é’¥è§£å¯† EncKDCRepPart è·å¾— KDC ä¼šè¯å¯†é’¥ï¼Œå¹¶åˆ¤æ–­ EncKDCRepPart ä¸­çš„ nonce æ˜¯å¦ä¸ KRB_AS_REQ ä¸­çš„ä¸€è‡´ï¼›éšååˆ›å»ºä¸€ä¸ª AP-REQ ç»“æ„ä½“ï¼Œ&lt;strong>ä½¿ç”¨ KDC ä¼šè¯å¯†é’¥åŠ å¯†å…¶ä¸­çš„ Authenticatorï¼Œæœ€åå°†ä¸è°ƒç”¨æœåŠ¡å‘ç»‘å®šçš„ SPN å°è£…å…¥ req-body çš„ sname ä¸­&lt;/strong>ï¼Œå¹¶å°è£…ä¸º KRB_TGS_REQ æ¶ˆæ¯å‘é€ç»™ TGS æœåŠ¡ä»¥æ¢å– STã€‚&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0l4czeqw0j21tj0u0jvq.jpg"
loading="lazy"
alt="image-20220324164755762"
>&lt;/p>
&lt;p>å…¶ä¸­çš„ nonce ä½œç”¨ä¸å‰æ–‡ä¸€è‡´ï¼Œç”¨äºåœ¨ ST çš„ç”³è¯·è¿‡ç¨‹ä¸­æ ¡éªŒ TGS æœåŠ¡çš„èº«ä»½ï¼ˆ&lt;strong>å¦‚æœ TGS æœåŠ¡æ˜¯ä¼ªé€ çš„ï¼Œé‚£ä¹ˆå®ƒæ— æ³•åŠ å¯†å¯¹åº”çš„ EncKDCRepPartï¼Œå› ä¸ºå…¶æ²¡æœ‰ç”¨æˆ·å¯†é’¥&lt;/strong>ï¼‰ï¼›å¯ä»¥æ³¨æ„åˆ°æ­¤å¤„è¿˜åŒ…å«ä¸€ä¸ªå¥‡æ€ªçš„ enc-authorizatfion-data ï¼Œä¸å¿…æƒŠè®¶ï¼Œè¿™æ˜¯ä¸€ä¸ªé¢å¤–å­—æ®µï¼ŒæŸäº›åº”ç”¨ç¨‹åºåœ¨è®¤è¯æ—¶éœ€è¦ç”¨åˆ°æ­¤å­—æ®µï¼Œ&lt;strong>å…¶ç”± authenticator ä¸­çš„ subkey è¿›è¡ŒåŠ å¯†ã€‚&lt;/strong>&lt;/p>
&lt;h2 id="krb_tgs_rep">KRB_TGS_REP&lt;/h2>
&lt;p>å½“ TGS æœåŠ¡æ”¶åˆ° KRB_TGS_REQ åï¼Œ&lt;strong>é¦–å…ˆä½¿ç”¨ krbtgt å¯†é’¥è§£å¯† TGT ä»è€Œè·å¾—å…ˆå‰åå•†çš„ KDC ä¼šè¯å¯†é’¥ï¼Œéšåä½¿ç”¨ KDC ä¼šè¯å¯†é’¥è§£å¯† authenticator å­—æ®µï¼Œå¹¶åˆ©ç”¨å…¶ä¸­çš„ subkey è§£å¯† enc-authorizatfion-data ã€‚&lt;/strong>&lt;/p>
&lt;p>å¦‚æœä¸‰è€…éƒ½èƒ½è§£å¯†æˆåŠŸï¼Œåˆ™ä¼šè¿›è¡Œä¸€ç³»åˆ—çš„æ ¡éªŒï¼ŒåŒ…æ‹¬ TGT æ˜¯å¦è¿‡æœŸï¼Œæ•°æ®åŒ…æ˜¯å¦è¢«ç¯¡æ”¹ç­‰ç­‰ï¼›æ ¡éªŒé€šè¿‡å TGS ä¼šæå–å‡º req-body ä¸­çš„ snameï¼Œ&lt;strong>å¹¶åœ¨æ´»åŠ¨ç›®å½•ä¸­å¯»æ‰¾æœåŠ¡è´¦æˆ·å¯¹åº”çš„å“ˆå¸Œï¼Œä»¥æ­¤ä¸ºå¯†é’¥åŠ å¯† STï¼Œå¦‚æœ TGT ä¸­å­˜åœ¨ PACï¼Œåˆ™å°† PAC åŒæ ·æ”¾ç½®åˆ° ST ä¸­ï¼ŒåŒæ—¶è¿˜å°†ä½¿ç”¨ KDC ä¼šè¯å¯†é’¥ç”Ÿæˆ EncKDCRepPart ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«äº†åç»­è°ƒç”¨æœåŠ¡æ—¶éœ€è¦ç”¨ä¸Šçš„æœåŠ¡ä¼šè¯å¯†é’¥ï¼ˆST ä¸­åŒæ ·åŒ…å«ï¼‰&lt;/strong>ã€‚&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0l4cy5u8dj22fn0u0dm4.jpg"
loading="lazy"
alt="image-20220324165618219"
>&lt;/p>
&lt;h2 id="krb_ap_req-1">KRB_AP_REQ&lt;/h2>
&lt;p>å½“å®¢æˆ·ç«¯æ”¶åˆ° KRB_TGS_REP åï¼Œ&lt;strong>é¦–å…ˆä½¿ç”¨ KDC ä¼šè¯å¯†é’¥è§£å¯† EncTGSRepPart ï¼Œæ ¡éªŒå…¶ä¸­çš„ nonce æ˜¯å¦ä¸å®¢æˆ·ç«¯è®¾ç½®çš„ nonce ä¸€è‡´ï¼›æ ¡éªŒæˆåŠŸåä» EncTGSRepPart ä¸­æå–å‡ºæœåŠ¡ä¼šè¯å¯†é’¥ï¼Œä½¿ç”¨æœåŠ¡ä¼šè¯å¯†é’¥åŠ å¯† Authenticator ä»¥æ­¤å‘æœåŠ¡ç«¯éªŒè¯èº«ä»½ï¼Œå¹¶å°† ST ä¸ Authenticator ä¸€åŒå‘é€ç»™æœåŠ¡ç«¯ã€‚&lt;/strong>&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0l4cwaw5hj21rl0u0ag9.jpg"
loading="lazy"
alt="image-20220324170821520"
>&lt;/p>
&lt;h2 id="krb_ap_repå¯é€‰">KRB_AP_REPï¼ˆå¯é€‰ï¼‰&lt;/h2>
&lt;p>æœåŠ¡ç«¯æ”¶åˆ° KRB_AP_REQ åï¼Œ&lt;strong>é¦–å…ˆä½¿ç”¨å…¶æœåŠ¡å¯†é’¥è§£å¯† ST ï¼Œä»ä¸­æå–å‡ºæœåŠ¡ä¼šè¯å¯†é’¥ï¼Œå¹¶å°è¯•ä½¿ç”¨æœåŠ¡ä¼šè¯å¯†é’¥è§£å¯† Authenticator ï¼Œå¦‚æœè§£å¯†æˆåŠŸåˆ™ä»£è¡¨å®¢æˆ·ç«¯çš„èº«ä»½éªŒè¯æˆåŠŸï¼Œæ­¤æ—¶åˆ™æ ¹æ® ST ä¸­çš„ PAC å¯¹ç”¨æˆ·æƒé™è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚å…¶æ‹¥æœ‰è¶³å¤Ÿçš„æƒé™åˆ™å‘å…¶æä¾›æœåŠ¡ã€‚&lt;/strong>&lt;/p>
&lt;p>KRB_AP_REP æ˜¯å¯é€‰çš„ï¼Œå¤šç”¨äºä¼ é€’é”™è¯¯ä¿¡æ¯æˆ–ç”±æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯éªŒè¯èº«ä»½ï¼ˆnonceï¼‰ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0l4cupmsjj22kh0u0aik.jpg"
loading="lazy"
alt="image-20220324171233123"
>&lt;/p>
&lt;h1 id="æ€»ç»“">æ€»ç»“&lt;/h1>
&lt;p>ä¸Šé¢ä¸€ä¸²æµç¨‹ä¸‹æ¥ä¹Ÿè®¸ä¼šè§‰å¾—å¾ˆç»•ï¼Œæ¯•ç«Ÿå…¶ä¸­ä½¿ç”¨äº†å¤§é‡çš„ä¸´æ—¶ä¼šè¯å¯†é’¥ä¸åŠ å¯†å¯†é’¥ï¼ŒåŒæ—¶è¿˜ç”¨ä¸Šäº†è®¸å¤šä¸åŒçš„ç»“æ„ä½“ï¼Œæ¥ä¸‹æ¥ç®€å•æ¢³ç†ä¸€ä¸‹æ¯ä¸ªå¯†é’¥éƒ½æ˜¯åœ¨å“ªç”Ÿæˆã€åœ¨å“ªä½¿ç”¨çš„ã€‚&lt;/p>
&lt;ul>
&lt;li>KRB_AS_REQ
&lt;ul>
&lt;li>ä½¿ç”¨äº†ç”¨æˆ·å¯†é’¥&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>KRB_AS_REP
&lt;ul>
&lt;li>ä½¿ç”¨äº†ç”¨æˆ·å¯†é’¥&lt;/li>
&lt;li>ä½¿ç”¨äº† krbtgt å¯†é’¥&lt;/li>
&lt;li>ç”Ÿæˆäº† KDC ä¼šè¯å¯†é’¥&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>KRB_TGS_REQ
&lt;ul>
&lt;li>ä½¿ç”¨äº†ç”¨æˆ·å¯†é’¥&lt;/li>
&lt;li>ä½¿ç”¨äº† KDC ä¼šè¯å¯†é’¥&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>KRB_TGS_REP
&lt;ul>
&lt;li>ä½¿ç”¨äº† KDC ä¼šè¯å¯†é’¥&lt;/li>
&lt;li>ç”Ÿæˆäº†æœåŠ¡ä¼šè¯å¯†é’¥&lt;/li>
&lt;li>ä½¿ç”¨äº† krbtgt å¯†é’¥&lt;/li>
&lt;li>ä½¿ç”¨äº†æœåŠ¡å¯†é’¥&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>KRB_AP_REQ
&lt;ul>
&lt;li>ä½¿ç”¨äº† KDC ä¼šè¯å¯†é’¥&lt;/li>
&lt;li>ä½¿ç”¨äº†æœåŠ¡ä¼šè¯å¯†é’¥&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>KRB_AP_REP
&lt;ul>
&lt;li>ä½¿ç”¨äº†æœåŠ¡ä¼šè¯å¯†é’¥&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>ä»”ç»†çœ‹å®Œåæ„Ÿè§‰ Kerberos ä¹‹æ‰€ä»¥å¤æ‚å¹¶ä¸ä»…ä»…åœ¨äºå…¶åŠ å¯†æµç¨‹ï¼Œè€Œåœ¨äºå…¶æ¯ä¸€æ¬¡é€šä¿¡éƒ½å­˜åœ¨ç€å¤§é‡çš„åŠ è§£å¯†ã€ä¸¤ç«¯èº«ä»½çš„ç›¸äº’éªŒè¯ã€æ¶ˆæ¯çš„ä¿å¯†æ€§ï¼ŒåŒæ—¶è¿˜éœ€è¦ç¡®ä¿ TGT å’Œ ST çš„å®‰å…¨æ€§ã€å®Œæ•´æ€§ç­‰ï¼Œåªèƒ½è¯´è®¾è®¡è¿™ä¸ªåè®®çš„å›¢é˜ŸçœŸçš„å¤ª ğŸ®ğŸº è¾£ï¼&lt;/p></description></item><item><title>NTLM Protocol</title><link>https://tlmn-local.github.io/2022/03/17/ntlm-protocol/</link><pubDate>Thu, 17 Mar 2022 16:27:29 +0800</pubDate><guid>https://tlmn-local.github.io/2022/03/17/ntlm-protocol/</guid><description>&lt;h1 id="æ¦‚è¿°">æ¦‚è¿°&lt;/h1>
&lt;p>NTLM æ˜¯ Windows ä¼—å¤šè®¤è¯åè®®ä¹‹ä¸€ï¼Œæ—©æœŸæ›¾æ˜¯ Windows ä¸»è¦çš„è®¤è¯æ–¹å¼ï¼Œå³ä½¿åœ¨åæ¥ Kerberos å–ä»£äº† NTLM ä½œä¸ºé¦–é€‰çš„èº«ä»½è®¤è¯åè®®ï¼Œä½†è¿˜æ˜¯æœ‰å¾ˆå¤šåœºæ™¯å¿…ç„¶éœ€è¦ä½¿ç”¨åˆ° NTLM è¿›è¡Œèº«ä»½è®¤è¯ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š&lt;/p>
&lt;ul>
&lt;li>å…¶ä¸­ä¸€æ–¹ä¸æ”¯æŒ Kerberos&lt;/li>
&lt;li>å…¶ä¸­ä¸€æ–¹æœªåŠ å…¥åŸŸä¸­ï¼ˆå·¥ä½œç»„ç¯å¢ƒï¼‰&lt;/li>
&lt;li>åº”ç”¨ç¨‹åºé€‰æ‹©ä½¿ç”¨ NTLM ä½œä¸ºè®¤è¯åè®®ï¼ˆå¦‚éƒ¨åˆ† HTTPã€SMBã€SMTPã€MSSQL&amp;hellip;ï¼‰&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥å‘ç° NTLM åœ¨ç°åœ¨ä¹Ÿæœ‰ç€å¤§é‡çš„ä½¿ç”¨åœºæ™¯ï¼Œå› æ­¤ç ”ç©¶å®ƒçš„åŸç†ã€è„†å¼±æ€§åŠä¿®å¤æ–¹å¼ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œæ— è®ºä½ æ˜¯ä½œä¸ºæ”»å‡»è€…æˆ–æ˜¯é˜²å®ˆæ–¹ã€‚&lt;/p>
&lt;p>NTLM æ˜¯ä¸€ç§åŸºäºæŒ‘æˆ˜/å“åº”çš„èº«ä»½è®¤è¯åè®®ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œ&lt;strong>NTLM æ˜¯ä½œä¸ºç¬¬ä¸‰æ–¹æ¨¡å—å•ç‹¬åµŒå…¥åˆ°åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„&lt;/strong>ï¼Œåº”ç”¨ç¨‹åºä½¿ç”¨ NTLM è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶å°†ä¼šè¯å±‚ä¸è®¤è¯å±‚ç›¸äº’éš”ç¦»ï¼Œè®¤è¯ç»†èŠ‚å¯¹åº”ç”¨ç¨‹åºæ˜¯é€æ˜çš„ï¼Œè¿™ç§è®¤è¯æ–¹å¼æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œåæ–‡ä¸­ä¼šè°ˆåˆ°ã€‚&lt;/p>
&lt;p>ä¸‹å›¾æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ä½¿ç”¨ NTLM è¿›è¡Œè®¤è¯çš„ä¸€èˆ¬æµç¨‹ï¼Œå¯ä»¥å‘ç° NTLM Message æ˜¯åµŒå…¥åˆ°åº”ç”¨ç¨‹åºæ­£å¸¸çš„ Message ä¸­çš„ï¼š&lt;/p>
&lt;img src="https://docs.microsoft.com/zh-cn/openspecs/windows_protocols/ms-nlmp/ms-nlmp_files/image001.png" alt="Typical NTLM authentication message flow" style="zoom:150%;" />
&lt;p>NTLM æœ‰ç€æ‚ ä¹…çš„å‘å±•å†å²ï¼Œä½œä¸º Windows æœ€æ—©çš„è®¤è¯åè®®ä¹‹ä¸€ï¼Œå…¶æœ‰ç€å¤šä¸ªå†å²ç‰ˆæœ¬ï¼Œ&lt;strong>åŒ…æ‹¬ LMã€NTLMv1 å’Œ NTLMv2ï¼Œå‡ ä¸ªç‰ˆæœ¬çš„è®¤è¯æµç¨‹åŸºæœ¬ç›¸åŒï¼ŒåŒºåˆ«ä»…åœ¨äºè®¡ç®— Response çš„æ–¹å¼ä¸è®¾ç½®äº†å“ªäº› Response å­—æ®µã€‚&lt;/strong>&lt;/p>
&lt;h1 id="ä¸¤ç§æ¨¡å¼">ä¸¤ç§æ¨¡å¼&lt;/h1>
&lt;p>NTLM å¯¹äºè¿æ¥æ˜¯å¦ä¿æŒï¼ˆTCPã€UDPï¼‰è®¾è®¡äº†ä¸¤ç§è®¤è¯æ¨¡å¼ï¼Œä¸€ç§æ˜¯é¢å‘è¿æ¥çš„ï¼Œå¦ä¸€ç§åˆ™æ˜¯æ— è¿æ¥çš„ï¼Œå‰è€…æ˜¯ç›®å‰ç”¨çš„æœ€å¤šçš„æ¨¡å¼ï¼ˆå› ä¸ºå¤§éƒ¨åˆ†ä½¿ç”¨ NTLM ä½œä¸ºè®¤è¯åè®®çš„åº”ç”¨å‡é‡‡ç”¨ TCP è¿›è¡Œæ•°æ®ä¼ è¾“ï¼‰ã€‚&lt;/p>
&lt;p>é¢å‘è¿æ¥çš„è®¤è¯æµç¨‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;img src="https://docs.microsoft.com/zh-cn/openspecs/windows_protocols/ms-nlmp/ms-nlmp_files/image002.png" alt="Connection-oriented NTLM message flow" style="zoom:150%;" />
&lt;p>é¦–å…ˆæ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¼šè¿›è¡Œæ­£å¸¸é€šä¿¡ï¼Œéšåå®¢æˆ·ç«¯å‘èµ· NEGOTIATE æ¶ˆæ¯å‘ŠçŸ¥æœåŠ¡ç«¯å¼€å§‹è®¤è¯ï¼ŒæœåŠ¡ç«¯å‘é€ CHALLENGE æ¶ˆæ¯å‘ŠçŸ¥å®¢æˆ·ç«¯ Challengeï¼Œå®¢æˆ·ç«¯è®¡ç®—åå¾—åˆ° Response å¹¶å‘é€ AUTHENTICATE æ¶ˆæ¯è¿›è¡Œè®¤è¯ï¼Œ&lt;strong>æ³¨æ„æœ€åä¸€æ¡ Application message ä¸ä»£è¡¨æœåŠ¡ç«¯ä¸å‘ŠçŸ¥å®¢æˆ·ç«¯è®¤è¯ç»“æœï¼Œè€Œæ˜¯å› ä¸ºè®¤è¯ç»“æœä»¥ä½•ç§å½¢å¼å‘é€æ˜¯ç”±åº”ç”¨ç¨‹åºå†³å®šçš„ï¼Œæ­¤æ—¶å·²ç»ä¸ NTLM æ— å…³äº†ã€‚&lt;/strong>&lt;/p>
&lt;p>æ— è¿æ¥çš„è®¤è¯æµç¨‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;img src="https://docs.microsoft.com/zh-cn/openspecs/windows_protocols/ms-nlmp/ms-nlmp_files/image003.png" alt="Connectionless NTLM message flow" style="zoom:150%;" />
&lt;p>ä»ä¸Šè¿°è®¤è¯æµç¨‹ä¸Šçœ‹ï¼Œ&lt;strong>è™½ç„¶æ˜¯æœåŠ¡ç«¯å…ˆå‘å®¢æˆ·ç«¯å‘é€äº† Challengeï¼Œä½†å®é™…ä¸Šæ˜¯ç”±å®¢æˆ·ç«¯é€šè¿‡åº”ç”¨ç¨‹åºè‡ªå®šä¹‰çš„æŸç§æ¶ˆæ¯å…ˆå¯åŠ¨äº†è®¤è¯æµç¨‹&lt;/strong>ï¼Œä»æ•´ä½“ä¸Šçœ‹ä¸é¢å‘è¿æ¥çš„è®¤è¯æ–¹å¼åŸºæœ¬ä¸€è‡´ï¼Œåªä¸è¿‡ç¬¬ä¸€æ­¥è½¬ä¸ºäº†åº”ç”¨ç¨‹åºè‡ªå®šä¹‰çš„æ¶ˆæ¯ã€‚&lt;/p>
&lt;p>ä¸Šé¢è¯´äº† NTLM å­˜åœ¨å¤šä¸ªç‰ˆæœ¬ï¼Œ&lt;strong>å…¶ä¸­ LM å·²ç»åŸºæœ¬åºŸå¼ƒï¼Œè¾ƒä¸ºå¸¸ç”¨çš„æ˜¯ NTLMv1 ä¸ NTLMv2 ä¸¤ä¸ªç‰ˆæœ¬&lt;/strong>ï¼Œè‡³äºä½¿ç”¨å“ªä¸ªç‰ˆæœ¬è¿›è¡Œè®¤è¯ï¼Œåˆ™éœ€è¦å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å…±åŒè®¾ç½®ï¼Œé€šå¸¸è¿™é‡Œä¸ä¼šè¿›è¡Œåå•†ï¼Œè€Œæ˜¯ç›´æ¥åœ¨åº”ç”¨ç¨‹åºä¸­å†™æˆå›ºå®šä»£ç ã€‚&lt;/p>
&lt;h1 id="hash">Hash&lt;/h1>
&lt;p>Windows ä¸­ä¸ä¼šå­˜å‚¨ç”¨æˆ·å¯†ç çš„æ˜æ–‡ï¼Œåªä¼šå­˜å‚¨å…¶ Hashï¼ˆåæ–‡ç§°ä¸ºå“ˆå¸Œï¼‰ï¼Œ&lt;strong>æœ¬åœ°ç”¨æˆ·çš„å¯†ç å“ˆå¸Œå­˜æ”¾äºå½“å‰æœºå™¨çš„ SAM æ–‡ä»¶ä¸­ï¼ŒåŸŸç”¨æˆ·çš„å¯†ç å“ˆå¸Œåˆ™å­˜æ”¾äºåŸŸæ§åˆ¶å™¨ï¼ˆDomain Controllerï¼‰çš„ NTDS.DIT æ–‡ä»¶ä¸­&lt;/strong>ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯ä¸å¯è®¿é—®çš„ï¼Œä½†å¯åˆ©ç”¨å…¶å®ƒæ–¹å¼å°†å“ˆå¸Œå¯¼å‡ºã€‚&lt;/p>
&lt;p>ç”¨æˆ·å“ˆå¸Œé€šå¸¸ç”± LM-Hash ä¸ NT-Hash ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­ LM-Hash æ˜¯ Windows æœ€æ—©ä½¿ç”¨çš„åŠ å¯†ç®—æ³•ï¼Œæ ¸å¿ƒä½¿ç”¨äº† DES ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œç”±äº LM-Hash å­˜åœ¨è¾ƒå¤šçš„å®‰å…¨é£é™©ï¼Œäºæ˜¯ä» Windows Vista å’Œ Windows Server 2008 å¼€å§‹ï¼ŒWindows é»˜è®¤ç¦ç”¨äº† LM-Hashï¼Œåªå¯ç”¨ NT-Hashï¼ˆ&lt;strong>æœ‰çš„æ–‡ä¸­ä¹Ÿå°†å…¶ç§°ä¸º NTLM-Hash æˆ–æ˜¯ NTLMï¼Œä¸ºäº†é¿å…ä¸åè®®åç§°æ··æ·†ï¼Œè¿™é‡Œè®°ä¸º NT-Hash&lt;/strong>ï¼‰ï¼Œå› æ­¤åœ¨å¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¸­æˆ‘ä»¬è·å–åˆ°çš„å“ˆå¸Œå¯èƒ½æ˜¯è¿™æ ·çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">{Username}:{SID}:AAD3B435B51404EEAAD3B435B51404EE:62f83cc8d728c97df1e3b0a94e5c3ef9
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ &lt;code>AAD3B435B51404EEAAD3B435B51404EE&lt;/code> ä¸º LM-Hashï¼Œ&lt;code>62f83cc8d728c97df1e3b0a94e5c3ef9&lt;/code> ä¸º NT-Hashï¼Œå¦‚æœæŸç”¨æˆ·æ²¡æœ‰è®¾ç½®å¯†ç æˆ–å½“å‰çš„æ“ä½œç³»ç»Ÿè®¾ç½®ä¸ºä¸å­˜å‚¨ LM-Hashï¼Œé‚£ä¹ˆæ‰€è·å–åˆ°çš„ LM-Hash å°±æ˜¯ &lt;code>AAD3B435B51404EEAAD3B435B51404EE&lt;/code> ï¼Œå¯ä»¥ç†è§£ä¸ºç©ºå€¼ï¼Œæ­¤å“ˆå¸Œå¹¶æ²¡æœ‰ä»·å€¼ï¼Œä½†æŸäº›å·¥å…·è¦æ±‚è¾“å…¥æ ¼å¼ä¸º &lt;code>{LM-Hash}:{NT-Hash}&lt;/code> ï¼Œæ­¤æ—¶å¯å°†å…¶è®¾ç½®ä¸º 0 å€¼ï¼š&lt;code>00000000000000000000000000000000:{NT-Hash}&lt;/code> å³å¯ã€‚&lt;/p>
&lt;p>å¤‡æ³¨ï¼š&lt;/p>
&lt;ul>
&lt;li>SAM Pathï¼šC:\Windows\System32\config\SAM&lt;/li>
&lt;li>NTDS.DIT Pathï¼š%SystemRoot%\NTDS\ntds.dit&lt;/li>
&lt;/ul>
&lt;h2 id="lm-hash-åŠ å¯†ç®—æ³•">LM-Hash åŠ å¯†ç®—æ³•&lt;/h2>
&lt;p>LM Hash çš„åŠ å¯†ç®—æ³•å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>å°†æ‰€æœ‰å­—ç¬¦è½¬æ¢ä¸ºå¤§å†™å¹¶è½¬æ¢ä¸ºåå…­è¿›åˆ¶&lt;/li>
&lt;li>å¦‚æœé•¿åº¦ä¸è¶³14å­—èŠ‚åˆ™åœ¨å³ä¾§å¡«å…… NULL è¡¥å……&lt;/li>
&lt;li>å°†å­—ç¬¦ä¸²åˆ†å‰²ä¸ºä¸¤ä¸ª7å­—èŠ‚çš„ chunk&lt;/li>
&lt;li>å°†ä¸¤ä¸ª chunk åˆ†åˆ«å…ˆè½¬ä¸ºåå…­è¿›åˆ¶å†è½¬äºŒè¿›åˆ¶&lt;/li>
&lt;li>å¦‚æœ chunk çš„é•¿åº¦ä¸åˆ°56åˆ™å°†å…¶åˆ†å‰²ä¸º7ä½ä¸€ç»„å¹¶åœ¨æ¯ç»„æœ«å°¾åŠ 0ï¼ˆæœ€åä¸€ç»„é™¤å¤–ï¼‰&lt;/li>
&lt;li>å°†ç»“æœè½¬ä¸ºäºŒè¿›åˆ¶åå†è½¬åå…­è¿›åˆ¶&lt;/li>
&lt;li>å»é™¤å¼€å¤´çš„ 0x éƒ¨åˆ† ä»¥åŠå³ä¾§ L å­—ç¬¦åå†æ¬¡å°†ä¸¤ä¸ª chunk åˆ†åˆ«è½¬ä¸ºåå…­è¿›åˆ¶&lt;/li>
&lt;li>å°†ä¸¤ä¸ª chunk åˆ†åˆ«ä½œä¸º key é€šè¿‡ DES åŠ å¯† &lt;code>KGS!@#$%&lt;/code> å­—ç¬¦ä¸²&lt;/li>
&lt;li>å°†åŠ å¯†ç»“æœåˆå¹¶ï¼Œå¾—åˆ°æœ€ç»ˆçš„ LM-Hash&lt;/li>
&lt;/ol>
&lt;p>è½¬æ¢ä¸º Python ä»£ç å¦‚ä¸‹ï¼ˆPython3ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">binascii&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pyDes&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="o">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">encode_des&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">des&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ECB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pad&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">encrypt_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encrypt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">b2a_hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encrypt_data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">padding_zero&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">7&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">get_lm_hash&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">password&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">password&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">upper&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1"># è½¬æ¢ä¸ºå¤§å†™&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hex_password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">b2a_hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">password&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># è½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hex_password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hex_password&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ljust&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">28&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># ä¸è¶³åå››å­—èŠ‚çš„éƒ¨åˆ†ç”¨0è¡¥å…¨&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># å°†åå…­è¿›åˆ¶å­—ç¬¦ä¸²åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œæ¯éƒ¨åˆ†æœ‰ä¸ƒä¸ªå­—èŠ‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hex_password_part_one&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hex_password&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hex_password_part_two&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hex_password&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">28&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># å°†è¿™ä¸¤éƒ¨åˆ†åˆ†åˆ«å…ˆè½¬ä¸ºåå…­è¿›åˆ¶å†è½¬ä¸ºäºŒè¿›åˆ¶&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hex_password_part_one&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">bin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hex_password_part_one&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hex_password_part_two&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">bin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hex_password_part_two&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># å°†è¿™ä¸¤éƒ¨åˆ†åˆ†åˆ«ç”¨0å·¦å¡«å……é•¿åº¦è‡³56&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hex_password_part_one&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hex_password_part_one&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">lstrip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;0b&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rjust&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">56&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hex_password_part_two&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hex_password_part_two&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">lstrip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;0b&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rjust&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">56&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># å°†ä¸¤éƒ¨åˆ†åˆ†åˆ«ä»¥7ä½ä¸€ç»„ï¼Œæ¯ç»„æœ«å°¾åŠ 0ï¼ˆé™¤æœ€åä¸€ç»„ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">padding_part_one&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">padding_zero&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hex_password_part_one&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">padding_part_two&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">padding_zero&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hex_password_part_two&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># å°†ç»“æœè½¬æ¢ä¸ºäºŒè¿›åˆ¶åå†è½¬ä¸ºåå…­è¿›åˆ¶&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">padding_part_one&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">padding_part_one&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">padding_part_two&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">padding_part_two&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># å»é™¤å¼€å¤´çš„0xéƒ¨åˆ†ä»¥åŠå³ä¾§çš„Lå­—ç¬¦&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">padding_part_one&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">padding_part_one&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rstrip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;L&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">padding_part_two&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">padding_part_two&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rstrip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;L&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># å¦‚æœpart_2ä¸º0x0ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸º0000000000000000è¿›è¡Œé€‚é…&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">padding_part_two&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">padding_part_two&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;0000000000000000&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># å°†å…¶è½¬æ¢ä¸ºåå…­è¿›åˆ¶&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">padding_part_one&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">a2b_hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">padding_part_one&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">padding_part_two&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">a2b_hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">padding_part_two&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># å°†æ¯ä¸ªéƒ¨åˆ†ä½œä¸ºkeyåŠ å¯†KGS!@#$%å­—ç¬¦ä¸²&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lm_part_one&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">encode_des&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;KGS!@#$%&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">padding_part_one&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lm_part_two&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">encode_des&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;KGS!@#$%&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">padding_part_two&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ä¸¤ç»„desåŠ å¯†ç»“æœæ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå°±æ˜¯æœ€ç»ˆçš„ç»“æœ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">final_lm_hash&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lm_part_one&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lm_part_two&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">final_lm_hash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">get_lm_hash&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;password&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»ä»£ç ä¸Šçœ‹ï¼ŒLM-Hash å­˜åœ¨è®¸å¤šè„†å¼±çš„è®¾è®¡ï¼Œå¦‚ï¼š&lt;/p>
&lt;ul>
&lt;li>ä¸åŒºåˆ†å¤§å°å†™&lt;/li>
&lt;li>å¯†ç é•¿åº¦ä¸èƒ½è¶…è¿‡14ä½&lt;/li>
&lt;li>ä½¿ç”¨åˆ†ç»„æ‹¼æ¥çš„æ–¹å¼è®¡ç®— Hashï¼Œåœ¨å¾—åˆ° Hash åä¹Ÿå¯ä½¿ç”¨åˆ†ç»„çˆ†ç ´çš„æ–¹å¼è¿˜åŸå¯†ç ï¼Œå¹¶ä¸”å¦‚æœå¯†ç å°äº7ä½åˆ™ååŠæ®µåŠ å¯†å­—ç¬¦ä¸²å¿…ç„¶æ˜¯ &lt;code>aad3b435b51404ee&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="nt-hash-åŠ å¯†ç®—æ³•">NT-Hash åŠ å¯†ç®—æ³•&lt;/h2>
&lt;p>NT Hash çš„åŠ å¯†ç®—æ³•çš„è®¡ç®—æ­¥éª¤è¾ƒä¹‹LM Hashåˆ™ç®€å•è®¸å¤šï¼š&lt;code>MD4(UTF-16-LE(password))&lt;/code>ï¼Œè½¬æ¢ä¸ºPythonä»£ç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">hashlib&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">binascii&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;password&amp;gt;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexlify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hashlib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;md4&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">password&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;utf-16le&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">digest&lt;/span>&lt;span class="p">()),&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="éªŒè¯">éªŒè¯&lt;/h2>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h04u4d00sgj210h0u0gqg.jpg"
loading="lazy"
alt="verify-hash"
>&lt;/p>
&lt;p>å¯¹æµ‹è¯•å¯†ç  &lt;code>DC082!@#&lt;/code> è¿›è¡ŒåŠ å¯†è®¡ç®— LM-Hash ä¸ NT-Hashï¼Œæ‰€å¾—ç»“æœä¸å›¾ä¸­ä¸€è‡´ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ python3 lm_hash.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a0ecede8e75ed1b4c2a20cae7226e17d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ python3 nt_hash.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cdf300d7f4c17e59e3b96a05794aa007
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="ntlm">NTLM&lt;/h1>
&lt;p>å¾®è½¯æœ€æ—©ä½¿ç”¨çš„è®¤è¯åè®®æ˜¯ä½¿ç”¨ LM-Hash ä½œä¸ºå¯†é’¥çš„ LMï¼Œåœ¨ä¸Šé¢æ›¾æåŠ LM-Hash å­˜åœ¨è¯¸å¤šå®‰å…¨éšæ‚£ï¼Œå› æ­¤å¾®è½¯äº1993å¹´ Windows NT 3.1 ä¸­å¼•å…¥äº† NTLMv1ï¼Œå¹¶åŠ å…¥äº† NT-Hashï¼Œæ­¤æ—¶ LM-Hash ä¸ NT-Hash å°†å…±åŒä½¿ç”¨ï¼ŒåŒæ—¶ä¸ºäº†ä¸€å®šç¨‹åº¦ç¼“è§£é‡æ”¾æ”»å‡»ï¼Œå¾®è½¯åœ¨ Windows NT 4.0.SP4 ä¸­å¼•å…¥äº† NTLMv2ï¼›æœ¬æ–‡å°†ç»“åˆ SMB çš„è°ƒç”¨æµç¨‹æ¥å¯¹ NTLM çš„è®¤è¯è¿‡ç¨‹è¿›è¡Œå®é™…åˆ†æï¼ˆè¿™é‡Œä¸åŒºåˆ†v1æˆ–æ˜¯v2ï¼Œä¸¤ä¸ªç‰ˆæœ¬è®¤è¯æµç¨‹ä¸€è‡´ï¼‰ã€‚&lt;/p>
&lt;p>ä½¿ç”¨å‘½ä»¤ &lt;code>net use \\192.168.2.110 &amp;quot;Admin!@#$~!@#01&amp;quot; /user:&amp;quot;Administrator&amp;quot;&lt;/code> å°è¯•é€šè¿‡ SMB åè®®é“¾æ¥ 192.168.2.110 çš„å…±äº«èµ„æºï¼Œå…¶ä¸­ä¸ NTLM è®¤è¯æœ‰å…³çš„æ˜¯å›¾ä¸­åœˆèµ·æ¥çš„å››æ¡æ¶ˆæ¯ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h08m2rbgfwj21c00u0gw5.jpg"
loading="lazy"
alt="image-20220313221258206"
>&lt;/p>
&lt;p>é¦–å…ˆå®¢æˆ·ç«¯å‘é€ NEGOTIATE æ¶ˆæ¯å¯åŠ¨è®¤è¯æµç¨‹ï¼Œæ­¤æ¶ˆæ¯ä¼šå¯¹æœ¬æ¬¡è®¤è¯ä¸­ä½¿ç”¨çš„å®‰å…¨æœºåˆ¶è¿›è¡Œåå•†(flag)ï¼Œå¹¶å°†å®¢æˆ·ç«¯çš„åŸŸåå’Œå·¥ä½œç»„åä¸€åŒä¼ é€’ç»™æœåŠ¡ç«¯ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h08m7t0qclj21c00u0gut.jpg"
loading="lazy"
alt="image-20220313221749189"
>&lt;/p>
&lt;p>éšåæœåŠ¡ç«¯é¥­å CHALLENGE æ¶ˆæ¯å’Œ MORE_PROCESSING_REQUIRED çŠ¶æ€ç å‘ŠçŸ¥å®¢æˆ·ç«¯è¿˜éœ€è¦ä¼ é€’ç”¨æˆ·ä¿¡æ¯ä»¥è¿›è¡Œæ¥ä¸‹æ¥çš„è®¤è¯ï¼ŒCHALLENGE ä¸­åŒ…å«è¯¸å¤šæ¥è‡ªæœåŠ¡ç«¯çš„ä¿¡æ¯ï¼Œ&lt;strong>åŒ…æ‹¬æœ€é‡è¦çš„ Challenge&lt;/strong>ã€Timestampï¼ˆç”¨äºç¼“è§£é‡æ”¾æ”»å‡»ï¼‰å’ŒæœåŠ¡ç«¯æœºå™¨çš„ç›¸å…³ä¿¡æ¯ï¼ˆæœºå™¨åã€åŸŸåã€DNS åŸŸååŠ DNS æœºå™¨åï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h08menarawj21c00u0ais.jpg"
loading="lazy"
alt="image-20220313222423456"
>&lt;/p>
&lt;p>å½“å®¢æˆ·ç«¯æ”¶åˆ°è¿™ä¸€æ¡æ¶ˆæ¯åï¼Œä¼šä»ä¸­æå–å‡º challengeï¼Œå¹¶ä½¿ç”¨ç”¨æˆ·æä¾›çš„å¯†ç ç”Ÿæˆå¯¹åº”çš„ NT-Hash ä»¥åŠ LM-Hashï¼Œå¹¶ä½¿ç”¨å¯¹åº”çš„ Hash å¯¹ challenge å’Œå…¶ä½™ä¿¡æ¯åˆå¹¶åè¿›è¡ŒåŠ å¯†ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªåŠ å¯†ä¸²ï¼Œå…·ä½“å¤„ç†ä»£ç å¦‚ä¸‹ï¼ˆä¼ªä»£ç ï¼‰ã€‚&lt;/p>
&lt;p>NTLMv1ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> --
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- Functions Used:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- Z(M)- Defined in section 6.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Define NTOWFv1(Passwd, User, UserDom) as MD4(UNICODE(Passwd))
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EndDefine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Define LMOWFv1(Passwd, User, UserDom) as
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ConcatenationOf( DES( UpperCase( Passwd)[0..6],&amp;#34;KGS!@#$%&amp;#34;),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> DES( UpperCase( Passwd)[7..13],&amp;#34;KGS!@#$%&amp;#34;))
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EndDefine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set ResponseKeyNT to NTOWFv1(Passwd, User, UserDom)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set ResponseKeyLM to LMOWFv1( Passwd, User, UserDom )
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Define ComputeResponse(NegFlg, ResponseKeyNT, ResponseKeyLM,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CHALLENGE_MESSAGE.ServerChallenge, ClientChallenge, Time, ServerName)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> As
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> If (User is set to &amp;#34;&amp;#34; AND Passwd is set to &amp;#34;&amp;#34;)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- Special case for anonymous authentication
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set NtChallengeResponseLen to 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set NtChallengeResponseMaxLen to 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set NtChallengeResponseBufferOffset to 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set LmChallengeResponse to Z(1)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ElseIf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> If (NTLMSSP_NEGOTIATE_EXTENDED_SESSIONSECURITY flag is set in NegFlg)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set NtChallengeResponse to DESL(ResponseKeyNT,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> MD5(ConcatenationOf(CHALLENGE_MESSAGE.ServerChallenge,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ClientChallenge))[0..7])
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set LmChallengeResponse to ConcatenationOf{ClientChallenge,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Z(16)}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Else
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set NtChallengeResponse to DESL(ResponseKeyNT,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CHALLENGE_MESSAGE.ServerChallenge)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> If (NoLMResponseNTLMv1 is TRUE)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set LmChallengeResponse to NtChallengeResponse
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Else
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set LmChallengeResponse to DESL(ResponseKeyLM,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CHALLENGE_MESSAGE.ServerChallenge)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EndIf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EndIf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EndIf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set SessionBaseKey to MD4(NTOWF)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>NTLMv2ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Define NTOWFv2(Passwd, User, UserDom) as HMAC_MD5(
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> MD4(UNICODE(Passwd)), UNICODE(ConcatenationOf( Uppercase(User),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> UserDom ) ) )
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EndDefine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Define LMOWFv2(Passwd, User, UserDom) as NTOWFv2(Passwd, User,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> UserDom)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EndDefine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set ResponseKeyNT to NTOWFv2(Passwd, User, UserDom)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set ResponseKeyLM to LMOWFv2(Passwd, User, UserDom)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Define ComputeResponse(NegFlg, ResponseKeyNT, ResponseKeyLM,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CHALLENGE_MESSAGE.ServerChallenge, ClientChallenge, Time, ServerName)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> As
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> If (User is set to &amp;#34;&amp;#34; &amp;amp;&amp;amp; Passwd is set to &amp;#34;&amp;#34;)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -- Special case for anonymous authentication
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set NtChallengeResponseLen to 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set NtChallengeResponseMaxLen to 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set NtChallengeResponseBufferOffset to 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set LmChallengeResponse to Z(1)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Else
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set temp to ConcatenationOf(Responserversion, HiResponserversion,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Z(6), Time, ClientChallenge, Z(4), ServerName, Z(4))
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set NTProofStr to HMAC_MD5(ResponseKeyNT,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ConcatenationOf(CHALLENGE_MESSAGE.ServerChallenge,temp))
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set NtChallengeResponse to ConcatenationOf(NTProofStr, temp)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set LmChallengeResponse to ConcatenationOf(HMAC_MD5(ResponseKeyLM,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ConcatenationOf(CHALLENGE_MESSAGE.ServerChallenge, ClientChallenge)),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ClientChallenge )
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EndIf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Set SessionBaseKey to HMAC_MD5(ResponseKeyNT, NTProofStr)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EndDefine
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹æ¯”ä¸€ä¸‹ä¸¤è€…çš„åŠ å¯†ç®—æ³•ï¼Œå¯ä»¥å‘ç° NTLMv1 çš„åŠ å¯†è¾ƒä¸ºç®€å•ï¼ŒNTLMv2 çš„åŠ å¯†ä¸­é™¤äº† challenge å¤–è¿˜ä¼šå°†å¤§é‡ä¿¡æ¯é€šè¿‡è¿æ¥èµ·æ¥æœ€åæ‰è¿›è¡ŒåŠ å¯†ï¼ŒåŒæ—¶ä½¿ç”¨äº† HMAC_MD5 è¿›è¡Œä»¥ä¿æŠ¤æ•°æ®çš„å®Œæ•´æ€§ã€‚&lt;/p>
&lt;p>å¯ä»¥å‘ç° NTLMv1 æ˜¯ä¸å­˜åœ¨ NTProofStr è¿™ä¸ªæ•°æ®çš„ï¼Œå› æ­¤ä¹Ÿå¯ä»¥é€šè¿‡æ˜¯å¦å­˜åœ¨ NTProofStr æ¥åˆ¤æ–­å½“å‰è®¤è¯ä½¿ç”¨çš„æ˜¯å“ªä¸ªç‰ˆæœ¬ï¼Œä¸‹é¢æ˜¯ SMB2 ä¸­ä½¿ç”¨ NTLMv2 è¿›è¡Œè®¤è¯çš„ AUTHENTICATE æ¶ˆæ¯ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h08mt76v5yj21c00u0don.jpg"
loading="lazy"
alt="image-20220313223822719"
>&lt;/p>
&lt;p>&lt;strong>è¿™é‡Œçš„ NTLMv2 Response ä¸­çš„æ¯ä¸€ä¸ªå­—æ®µéƒ½æ˜¯å—åˆ° NTProofStr ä¿æŠ¤çš„ï¼Œå› ä¸º NTProofStr æ˜¯æ ¹æ®è¿™äº›å­—æ®µå€¼å’Œ challenge ç”Ÿæˆå‡ºæ¥çš„ï¼Œå› æ­¤æ–°å¢æˆ–æ˜¯ä¿®æ”¹å…¶ä¸­ä»»ä½•ä¸€ä¸ªå­—æ®µéƒ½ä¼šå¯¼è‡´æœåŠ¡ç«¯æœ€åæ ¡éªŒ NTProofStr ä¸æˆåŠŸï¼Œå› ä¸ºæ”»å‡»è€…æ— æ³•åœ¨æ²¡æœ‰ Hash çš„æƒ…å†µ ä¸‹é‡æ–°ç”Ÿæˆ NTProofStrï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œä¹Ÿç®—æ˜¯ NTLMv2 çš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚&lt;/strong>&lt;/p>
&lt;p>å½“æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„ Response åï¼Œå¯æ ¹æ®æœåŠ¡ç«¯ç¯å¢ƒåˆ†ä¸ºä¸¤ç§ä¸åŒçš„å¤„ç†æ–¹å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨åŸŸç¯å¢ƒä¸­ï¼ŒæœåŠ¡ç«¯å°† Challengeã€Response Username ç­‰ä¿¡æ¯å‘é€ç»™ DCï¼Œç”± DC è°ƒç”¨ NTOWFv2 ã€LMOWFv2 å¯¹å­˜å‚¨äº DC ä¸Šçš„åŸŸæˆå‘˜å“ˆå¸Œè®¡ç®—å¯¹åº”çš„ NTProofStr å’Œ LM-Responseï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„ç›¸åŒåˆ™è®¤è¯é€šè¿‡ï¼Œåä¹‹åˆ™ä¸é€šè¿‡&lt;/li>
&lt;li>åœ¨å·¥ä½œç»„ç¯å¢ƒä¸­ï¼ŒæœåŠ¡ç«¯è°ƒç”¨ NTOWFv2 ã€LMOWFv2 å¯¹å­˜å‚¨äºæœåŠ¡ç«¯æœºå™¨ä¸Šçš„ç”¨æˆ·å“ˆå¸Œè®¡ç®—å¯¹åº”çš„ NTProofStr å’Œ LM-Responseï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„ç›¸åŒåˆ™è®¤ä¸ºè®¤è¯é€šè¿‡ï¼Œåä¹‹åˆ™ä¸é€šè¿‡&lt;/li>
&lt;/ul>
&lt;h1 id="ntlm-relay">NTLM Relay&lt;/h1>
&lt;p>NTLM æœ‰ç€è®¸å¤šçš„æ”»å‡»é¢ï¼ŒåŒ…æ‹¬è¯¸å¦‚å“ˆå¸Œä¼ é€’ï¼ˆPTHï¼‰ã€å“ˆå¸Œçˆ†ç ´ç­‰ï¼Œä½†è¿™äº›éƒ½æ˜¯ä¸å“ˆå¸Œæœ‰å…³çš„ï¼Œæœ¬æ–‡åªè®°å½•ä¸åè®®æœ‰å…³çš„ä¸€ç§æ”»å‡»æ‰‹æ³•ï¼Œå³ NTLM Relayã€‚&lt;/p>
&lt;p>ä» NTLM çš„è®¤è¯æµç¨‹å¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡ç«¯ä¼šå¯¹å®¢æˆ·ç«¯çš„èº«ä»½è¿›è¡Œè®¤è¯ï¼Œç„¶è€Œå®¢æˆ·ç«¯å¹¶ä¸ä¼šå¯¹æœåŠ¡ç«¯çš„èº«ä»½è¿›è¡Œè®¤è¯ï¼ˆå³å•å‘è®¤è¯ï¼‰ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ç§å•å‘è®¤è¯ï¼Œæ‰äº§ç”Ÿäº† NTLM Relay è¿™ç§ä¸­é—´äººæ”»å‡»çš„æ‰‹æ³•ã€‚&lt;/p>
&lt;p>æ­£å¸¸çš„è®¤è¯æµç¨‹æ˜¯å‘ä¸‹å›¾è¿™æ ·çš„ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0ao4lmdfsj20ui08q0tu.jpg"
loading="lazy"
alt="NTLM Challenge Response"
>&lt;/p>
&lt;p>å‡è®¾æ”»å‡»è€…æœ‰èƒ½åŠ›ä½œä¸ºä¸­é—´äººçš„èº«ä»½å­˜åœ¨äºå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´ï¼ˆä¹Ÿå°±æ˜¯èƒ½å¤Ÿè®©å®¢æˆ·ç«¯ä¸»åŠ¨å‘æ”»å‡»è€…å‘èµ· NTLM è®¤è¯è¯·æ±‚ï¼‰ï¼Œæ­¤æ—¶æ”»å‡»è€…åªéœ€è¦ç®€å•çš„è½¬å‘æ•°æ®åŒ…ï¼Œå³å¯ä»¥å®¢æˆ·ç«¯çš„èº«ä»½è°ƒç”¨æœåŠ¡ç«¯æ‰€æä¾›çš„æœåŠ¡ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0ao86gjlxj20ut0i5mzt.jpg"
loading="lazy"
alt="NTLM Relay"
>&lt;/p>
&lt;p>ä»¥æœåŠ¡å™¨çš„è§’åº¦çœ‹ï¼Œå®ƒå·²ç»å®Œæˆäº†å¯¹å®¢æˆ·ç«¯çš„èº«ä»½éªŒè¯ï¼Œå¹¶ä¸”å®Œå…¨æ— æ³•æ„è¯†åˆ°æ­¤æ—¶çš„é€šä¿¡ä¸­å­˜åœ¨ç€ä¸­é—´äººï¼Œå½“èº«ä»½è®¤è¯å®Œæˆåï¼Œæ”»å‡»è€…å¯ä½¿ç”¨æœåŠ¡ç«¯ä¸‹å‘çš„è®¤è¯å‡­æ®ä»¥å®¢æˆ·ç«¯çš„èº«ä»½è°ƒç”¨å…¶å¯¹å¤–æä¾›çš„æœåŠ¡ã€‚&lt;/p>
&lt;p>å¦‚æœæ ¹æ® Relay çš„å¯¹è±¡æ¥åŒºåˆ†ï¼Œå¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šå·¥ä½œç»„ç¯å¢ƒé€šå¸¸æ˜¯ Relay å›è‡ªèº«ä»¥è·å¾—ä¸»æœºæƒé™ï¼ŒåŸŸç¯å¢ƒè¾ƒä¹‹å·¥ä½œç»„ç¯å¢ƒæ‰©å……äº†è®¸å¤šç©æ³•ï¼Œæ­¤æ—¶åˆ™ä¸ä»…å±€é™äº Relay è‡ªèº«ï¼Œé€šå¸¸è¿˜å¯ Relay è‡³ DC ä»¥å®ç°å…¶å®ƒæ“ä½œã€‚&lt;/p>
&lt;p>ç°å‡è®¾å­˜åœ¨ Aã€Bã€C ä¸‰å°ä¸»æœºï¼Œå‡è®¾ A å’Œ C ä¸Šå­˜åœ¨ç€æŸä¸ªç”¨æˆ·åå’Œå¯†ç å‡ç›¸åŒçš„ç”¨æˆ·ï¼ˆå¦‚ Administratorï¼‰ï¼Œæ”»å‡»è€…è·å–åˆ°äº† B çš„æƒé™å¹¶ä¸”é€šè¿‡æŸç§æ–¹å¼å¯ä»¥è®© A ä¸»åŠ¨å‘èµ· SMB è¯·æ±‚ï¼Œé‚£ä¹ˆæ”»å‡»è€…å¯ä»¥åœ¨ B ä¸Šæ¶è®¾ä¸€ä¸ªæ¶æ„çš„ä¸­è½¬ SMB æœåŠ¡å™¨ï¼Œæ­¤æ—¶ B ä¸Šè·å¾— A çš„ NTLM è®¤è¯è¯·æ±‚å¹¶å°†å…¶è½¬å‘è‡³ C çš„ SMB æœåŠ¡ï¼ˆæ— è·¨åè®®ï¼‰ï¼Œä»è€Œè·å¾— C çš„ä¸»æœºæƒé™ï¼Œimpacket çš„ ntlmrelayx.py å·²ç»å¾ˆå¥½çš„é›†æˆäº† ntlm relay çš„å¤§éƒ¨åˆ†ç©æ³•ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0auhu0zl3j213r0u043n.jpg"
loading="lazy"
alt="image-20220315203522715"
>&lt;/p>
&lt;p>ä¸Šé¢æ˜¯æˆ‘é€šè¿‡ impacket å¯åŠ¨äº†ä¸€ä¸ªæ¶æ„çš„ SMB æœåŠ¡ï¼Œå¹¶å°†è®¤è¯è¯·æ±‚è½¬å‘ç»™ 192.168.2.112ï¼ˆCï¼‰ è¿™å°ä¸»æœºï¼ŒæˆåŠŸè®¤è¯åä¼šåœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œååºæˆ‘å¯é€šè¿‡æ­¤ä»£ç†è°ƒç”¨ç›®æ ‡çš„ SMB æœåŠ¡ï¼Œæ¯”å¦‚é€šè¿‡ smbexec.py å®ç°å‘½ä»¤æ‰§è¡Œï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0aukxgzg1j21v20eu79i.jpg"
loading="lazy"
alt="image-20220315203821491"
>&lt;/p>
&lt;p>çœ‹æµé‡å›¾ä¹Ÿè®¸èƒ½å¤Ÿæ›´å¥½çš„ç†è§£ NTLM Relayï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0atx94hylj226u06in32.jpg"
loading="lazy"
alt="image-20220315201536035"
>&lt;/p>
&lt;p>åœ¨ä¸Šå›¾ä¸­ï¼ŒA ä¸»æœºï¼ˆ192.168.2.113ï¼‰å‘ B ä¸»æœºï¼ˆ192.168.2.109ï¼‰å‘å‡ºçš„æ¶ˆæ¯ä¼šè¢«ä¿®æ”¹ï¼ˆä¿®æ”¹éƒ¨åˆ† Client ä¿¡æ¯ï¼‰åè½¬å‘åˆ° C ä¸»æœºï¼ˆ192.168.2.112ï¼‰ï¼Œéšåå°† C ä¸»æœºçš„å“åº”ä¿®æ”¹éƒ¨åˆ†ä¿¡æ¯åè½¬å‘ç»™ B ä¸»æœºã€‚&lt;/p>
&lt;p>ä¸Šé¢å¤šæ¬¡æåˆ°äº†è·¨åè®®ï¼Œä¸ºä»€ä¹ˆ NTLM Relay èƒ½å¤Ÿè·¨åè®®å‘¢ï¼Ÿ&lt;strong>è¿™æ˜¯å› ä¸º NTLM æ˜¯ä¸€ä¸ªåµŒå…¥å¼åè®®ï¼Œæ— è®ºå¯¹äºå“ªä¸ªä¸Šå±‚åº”ç”¨æ¥è¯´å®ƒçš„è®¤è¯æ–¹å¼æ˜¯ä¸å˜çš„ï¼Œä¸ä¼šå—åˆ°ä¸Šå±‚åº”ç”¨çš„å½±å“ï¼Œå› æ­¤å½“æ”»å‡»è€…æ”¶åˆ°ä¸€ä¸ª SMB çš„ NTLM è®¤è¯åï¼Œå¯è½¬å‘ç»™å…¶å®ƒæœºå™¨çš„ LDAP æˆ–æ˜¯å…¶å®ƒæœåŠ¡è¿›è¡Œè®¤è¯ã€‚&lt;/strong>&lt;/p>
&lt;h1 id="é˜²å¾¡æªæ–½">é˜²å¾¡æªæ–½&lt;/h1>
&lt;p>ä¸Šé¢ä»‹ç»äº† NTLM Relay çš„æ”»å‡»åŸç†ä¸æ”»å‡»åœºæ™¯ï¼Œæ¥ä¸‹æ¥å°†ä¸»è¦åˆ†æå¾®è½¯å¯¹äº NTLM Relay çš„å¤šç§é˜²å¾¡æªæ–½ï¼Œå…¶ä¸­æœ‰å‡ ç§é˜²å¾¡æªæ–½ç›¸è¾…ç›¸æˆï¼Œç›¸äº’å…³è”ï¼Œååˆ†ç²¾å½©ï¼&lt;/p>
&lt;h2 id="ms08-068">ms08-068&lt;/h2>
&lt;p>NTLM Relay ä¸ä»…å¯ä»¥ Relay åˆ°å…¶å®ƒæœºå™¨ï¼Œåœ¨å·¥ä½œç»„ç¯å¢ƒä¸‹ä¹Ÿå¯ä»¥ Relay åˆ°å‘å‡ºè¯·æ±‚çš„æœºå™¨å·²è·å¾—å…¶ä¸»æœºæƒé™ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0cqdxzrxpj20nu0nimyw.jpg" alt="Ghost_Potato_00.png" style="zoom:75%;" />
&lt;p>å¾®è½¯åœ¨2008å¹´å‘å¸ƒäº† ms08-068 è¡¥ä¸ç”¨äºç¼“è§£è¿™ç§ Relay To Self çš„åœºæ™¯ï¼Œå®ƒæ˜¯æ€ä¹ˆå·¥ä½œçš„å‘¢ï¼Ÿæ ¹æ®æ–‡æ¡£æè¿°ï¼ŒSMB å®¢æˆ·ç«¯åœ¨è¿›è¡Œè®¤è¯æ—¶éœ€è¦å¾ªç¯è°ƒç”¨ &lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta" target="_blank" rel="noopener"
>&lt;em>InitializeSecurityContext&lt;/em>&lt;/a>ç›´åˆ°å…¶è¿”å› SEC_E_OK æ‰è¡¨ç¤ºè®¤è¯æˆåŠŸï¼Œms08-068 çš„ä¿®å¤æ–¹å¼æ˜¯å°†è°ƒç”¨å‡½æ•°è¿‡ç¨‹ä¸­ä¼ é€’çš„ pszTargetName ç”±åŸå…ˆçš„ null ä¿®æ”¹ä¸ºæœåŠ¡ç«¯å…·ä½“æœåŠ¡çš„SPNï¼Œå³å½“æˆ‘ä»¬æƒ³è®¿é—® &lt;code>\\smb-server\share &lt;/code> æ—¶ï¼Œæ­¤å¤„ä¼šè¢«è®¾ç½®ä¸º &lt;code>cifs/smb-server&lt;/code> ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥è¦ä»‹ç»ä¸€ä¸‹ challenge cache æœºåˆ¶ï¼Œå®ƒæ˜¯èƒ½å¤Ÿé˜²å¾¡ Relay To Self çš„æ ¸å¿ƒåŸå› ï¼Œå½“ç„¶éœ€è¦æ­é… pszTargetName è¿›è¡Œä½¿ç”¨ï¼Œä¸‹é¢æ˜¯è¢«é˜²å¾¡çš„åœºæ™¯ï¼Œå‡è®¾ A æ˜¯å—å®³è€…çš„æœºå™¨ï¼ŒB æ˜¯ æ”»å‡»è€…çš„æœºå™¨ï¼Œæ”»å‡»è€…é€šè¿‡æŸç§æ–¹å¼è®© A å‘å…¶å‘èµ·äº† SMB è¯·æ±‚ï¼Œå¹¶å¸Œæœ› Relay To Aï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">A --&amp;gt; B --&amp;gt; A-SMB ï¼ˆNEGOTIATEï¼‰
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">A-SMB --&amp;gt; B --&amp;gt; A ï¼ˆCHALLENGEï¼‰ï¼Œæ­¤å¤„å½“ A æ”¶åˆ° challenge åï¼Œä¼šå°† challenge ä¸ B çš„ SPN ä¸€åŒç¼“å­˜
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">A --&amp;gt; B --&amp;gt; A-SMB ï¼ˆResponseï¼‰ï¼Œå½“ A çš„ SMB æœåŠ¡æ”¶åˆ° Responseåï¼Œä¼šåˆ¤æ–­ challenge æ˜¯å¦åœ¨æœ¬åœ°å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å¹¶ä¸” SPN ä¸ä¸ºæœ¬æœºï¼Œ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">åˆ™è®¤ä¸ºæ­¤æ¬¡ Response ä¸º NTLM Relay è½¬å‘è¿‡æ¥çš„ï¼Œå› æ­¤è®¤è¯å¤±è´¥
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="cve-2019-1384ghost-potato">CVE-2019-1384ï¼ˆGhost Potatoï¼‰&lt;/h3>
&lt;p>CVE-2019-1384 åˆ™æ˜¯ç”¨äºç»•è¿‡ ms08-068 çš„æ”»å‡»æ‰‹æ³•ï¼Œç”±äºç¼“å­˜è‡³å¤šå­˜åœ¨300sï¼Œè¿‡äº†300sç¼“å­˜å°±ä¼šè‡ªåŠ¨è¢«åˆ é™¤ï¼Œå› æ­¤åªéœ€è¦å°† SMB çš„è¯·æ±‚ä¸€ç›´ä¿æŒï¼Œç­‰å¾…300såå†å‘é€ Response å³å¯æˆåŠŸç»•è¿‡ ms08-068 çš„é˜²å¾¡ã€‚&lt;/p>
&lt;img src="https://shenaniganslabs.io/images/Ghost_Potato/Ghost_Potato_05.png" alt="Ghost_Potato_05.png" style="zoom:75%;" />
&lt;p>å¾®è½¯åœ¨ 2019å¹´12æœˆ11æ—¥ å‘å¸ƒäº†ä¿®å¤æ­¤æ¼æ´çš„è¡¥ä¸ï¼š&lt;a class="link" href="https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2019-1384" target="_blank" rel="noopener"
>CVE-2019-1384&lt;/a> ã€‚&lt;/p>
&lt;h2 id="ä¼šè¯ç­¾å">ä¼šè¯ç­¾å&lt;/h2>
&lt;p>æ­£å¦‚ä¹‹å‰è¯´çš„ä¸€æ ·ï¼ŒNTLM åªæ˜¯èº«ä»½è®¤è¯å±‚çš„å®ç°ï¼Œå½“èº«ä»½è®¤è¯å®Œæ¯•åï¼Œåº”ç”¨å±‚åè®®ä¼šç»§ç»­ä½¿ç”¨å®ƒä»¬çš„åè®®è§„èŒƒè¿›è¡ŒæœåŠ¡çš„è°ƒç”¨ï¼Œåç»­æœåŠ¡è°ƒç”¨çš„è¿‡ç¨‹è¢«ç§°ä¸ºä¼šè¯å±‚ï¼Œä¼šè¯ç­¾åæ˜¯åŸºäºç”¨æˆ· Hash ç”Ÿæˆçš„ï¼Œå› æ­¤æ”»å‡»è€…æ— æ³•ä¼ªé€ ã€‚&lt;/p>
&lt;p>å½“è®¤è¯å®Œæ¯•åï¼Œå¦‚æœå­˜åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡çš„åå•†çš„å†³å®šæ˜¯è¦å¯¹åç»­æ‰€æœ‰ä¼šè¯è¿›è¡Œç­¾åï¼Œé‚£ä¹ˆæ”»å‡»è€…å°†æ— æ³•åˆ©ç”¨ Relay ï¼Œå› ä¸ºæ”»å‡»è€…æ— æ³•ä¿®æ”¹ä¼šè¯æ—¶æ‰€è°ƒç”¨æœåŠ¡çš„ Action æˆ–æ˜¯ Relay å»å…¶å®ƒåè®®ï¼Œä¸‹å›¾æ˜¯åŸºäºä¼šè¯ç­¾åä¿æŠ¤çš„æœåŠ¡è°ƒç”¨æµç¨‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0bhpdot3kj20rk0j2dh4.jpg"
loading="lazy"
alt="Signature d&amp;rsquo;un paquet de session"
>&lt;/p>
&lt;p>ä¸‹å›¾æ˜¯åŸºäºä¼šè¯ç­¾åä¿æŠ¤çš„ NTLM Relay æµç¨‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0bhqfpmyrj20sp0p3dj6.jpg"
loading="lazy"
alt="ntlm_session_signing_failed"
>&lt;/p>
&lt;p>ç”±äºåç»­æ”»å‡»è€…å¿…ç„¶æƒ³è°ƒç”¨è‡ªå®šä¹‰çš„ Actionï¼ˆå¦‚ smbexecï¼‰ï¼Œä½†ç”±äºæ”»å‡»è€…æ²¡æœ‰åŠæ³•ç”Ÿæˆä¼šè¯ç­¾åï¼Œå› æ­¤æœåŠ¡ç«¯å¯¹ç­¾åçš„æ ¡éªŒå¤±è´¥ï¼Œå°†æ‹’ç»æä¾›æœåŠ¡ã€‚&lt;/p>
&lt;h3 id="smb-signing">SMB Signing&lt;/h3>
&lt;p>SMB åè®®çš„ä¼šè¯ç­¾åæ˜¯åœ¨ SMB åè®®ä¸­å®ç°çš„ï¼Œä¸æ¶‰åŠ NTLMï¼Œæ˜¯å¦éœ€è¦è¿›è¡Œç­¾åå®é™…ä¸Šæ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯åœ¨ NTLM è®¤è¯å‰å°±å·²ç»åå•†å¥½äº†çš„ï¼Œé¦–å…ˆå®¢æˆ·ç«¯ä¼šå‘æœåŠ¡ç«¯å‘é€ä¸€æ¡ NEGOTIATE æ¶ˆæ¯ä»¥å‘ŠçŸ¥æœåŠ¡ç«¯å…¶å¯¹ç­¾åçš„å¤„ç†æ–¹å¼ï¼ˆæ³¨æ„æ­¤å¤„çš„ NEGOTIATE ä¸ NTLM æ— å…³ï¼Œæ˜¯ SMB åè®®è‡ªå·±çš„ NEGOTIATEï¼‰ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0bi7bmfsxj21c00u0ahj.jpg"
loading="lazy"
alt="image-20220316101539136"
>&lt;/p>
&lt;p>éšåæœåŠ¡ç«¯ä¼šåœ¨ NEGOTIATE Response ä¸­å‘ŠçŸ¥å…¶å¯¹ç­¾åçš„å¤„ç†æ–¹å¼ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0bi9eimgpj21c00u0gtr.jpg"
loading="lazy"
alt="image-20220316101739166"
>&lt;/p>
&lt;p>å¯ä»¥å‘ç°æ­¤æ—¶å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„å¤„ç†æ–¹å¼éƒ½æ˜¯ enableï¼Œé‚£ä¹ˆå®ƒä»¬åˆ°åº•æ˜¯ç­¾åè¿˜æ˜¯ä¸ç­¾åå‘¢ï¼Ÿå¾®è½¯å®˜æ–¹æä¾›äº†ä¸€ä¸ªçŸ©é˜µç”¨äºç¡®å®š å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ã€NTLM ç‰ˆæœ¬ä¸ºä½•å€¼æ—¶éœ€è¦è¿›è¡Œç­¾åï¼Œå¹¶ä¸”å…¶ä¸­åŒ…å«ä¸€ç³»åˆ—é¢å¤–æ¡ä»¶ï¼Œå¦‚åŸŸæ§åˆ¶å™¨æ˜¯å¼ºåˆ¶ç­¾åçš„ä¹‹ç±»ã€‚&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0bibmcn1rj20uy0dswgg.jpg"
loading="lazy"
alt="Signing matrix"
>&lt;/p>
&lt;p>é€šè¿‡ä¸Šé¢çš„çŸ©é˜µå¯ä»¥å¾—å‡ºæœ¬æ¬¡æ˜¯å¦ç­¾åçš„ç»“è®ºï¼Œç”±äºæ­¤æ¬¡ä½¿ç”¨çš„æ˜¯ SMBv2 åè®®ï¼Œå¹¶ä¸”å¯¹è¯çš„åŒæ–¹å‡ä¸æ˜¯åŸŸæ§åˆ¶å™¨ï¼Œå› æ­¤åç»­ä¼šè¯å°†ä¸è¿›è¡Œç­¾åéªŒè¯ã€‚&lt;/p>
&lt;p>å½“å®¢æˆ·ç«¯å‘åŸŸæ§åˆ¶å™¨éªŒè¯èº«ä»½æ—¶æ˜¯éœ€è¦ç­¾åçš„ï¼Œä½†å½“åŸŸæ§åˆ¶å™¨å‘å¦å¤–ä¸€å°åŸŸæ§åˆ¶å™¨éªŒè¯èº«ä»½æ—¶åˆ™æ˜¯ä¸éœ€è¦ç­¾åçš„ã€‚&lt;/p>
&lt;p>æ€»ç»“ä¸€ä¸‹æ•´ä¸ªæµç¨‹ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯¹åº”çš„ä¸Šå±‚åè®®åœ¨ NEGOTIATE æ¶ˆæ¯ä¸­å‘ŠçŸ¥å¯¹æ–¹å…¶å¯¹ç­¾åçš„å¤„ç†æ–¹å¼&lt;/li>
&lt;li>Client åœ¨ NTLM NEGOTIATE æ¶ˆæ¯ä¸­å‘ŠçŸ¥ Server å…¶æ˜¯å¦æ”¯æŒç­¾åï¼ŒServer åœ¨ NTLM Challenge ä¸­å‘ŠçŸ¥ Client å…¶æ˜¯å¦æ”¯æŒç­¾å&lt;/li>
&lt;li>Client è®¤è¯å®Œæ¯•ï¼Œå‘èµ·åç»­ä¼šè¯ï¼Œå¦‚æœå‰é¢ä¸€ç³»åˆ—çš„åå•†ç»“æœä¸ºéœ€è¦ç­¾åï¼Œåˆ™ Client ä¼šåœ¨åç»­æµé‡ä¸­æ·»åŠ ä¸€ä¸ª Signature å­—æ®µç”¨äºç­¾åï¼ŒServer ä¸ Client çš„å¤„ç†æ–¹å¼ä¸€è‡´&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0bih87eapj20pd0e4adj.jpg"
loading="lazy"
alt="Session signing"
>&lt;/p>
&lt;h3 id="ldap-signing">LDAP Signing&lt;/h3>
&lt;p>åœ¨è°ƒç”¨ LDAP æœåŠ¡æ—¶ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯åŒæ ·æœ‰ç€ 3 ä¸ªé€‰é¡¹æ¥åå•†æ˜¯å¦éœ€è¦è¿›è¡Œç­¾åï¼š&lt;/p>
&lt;ul>
&lt;li>Disabledï¼šä¸æ”¯æŒæ•°æ®åŒ…ç­¾å&lt;/li>
&lt;li>Negotiatedï¼šå¯ä»¥å¤„ç†ç­¾åï¼Œä½†ä¸è¦æ±‚ä¸€å®šè¦ç­¾å&lt;/li>
&lt;li>Requiredï¼šå¿…é¡»å¯¹æ•°æ®åŒ…è¿›è¡Œç­¾å&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0bsq5t9zgj20us0bxt9w.jpg"
loading="lazy"
alt="LDAP signing matrix"
>&lt;/p>
&lt;p>LDAP æ˜¯åœ¨ NTLM è®¤è¯æ—¶è¿›è¡Œç­¾ååå•†çš„ï¼Œé¦–å…ˆåœ¨ NTLM NEGOTIATE æ¶ˆæ¯ä¸­ï¼Œå®¢æˆ·ç«¯ä¼šè®¾ç½® Flag è¡¨ç¤ºå…¶èƒ½å¤Ÿå¤„ç†ç­¾åï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0bhvqwb0cj21c00u046t.jpg"
loading="lazy"
alt="image-20220316100431400"
>&lt;/p>
&lt;p>éšåæœåŠ¡ç«¯ä¼šåœ¨ CHALLENGE æ¶ˆæ¯ä¸­è®¾ç½® Flag ä»¥å‘ŠçŸ¥å…¶æ˜¯å¦èƒ½å¤Ÿå¤„ç†ç­¾åï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0bhyp2sy4j21c00u0aie.jpg"
loading="lazy"
alt="image-20220316100721872"
>&lt;/p>
&lt;p>ç”±äºé»˜è®¤æƒ…å†µä¸‹é™¤äº†åŸŸæ§å¤–çš„æ‰€æœ‰ä¸»æœºæœ€ç»ˆçš„åå•†å‡ä¸º Negotiatedï¼ˆä¸¤å°æœåŠ¡å™¨å‡èƒ½å¤Ÿå¤„ç†ç­¾åï¼‰ï¼Œè¿™ä¹Ÿè¡¨ç¤ºæ­£å¸¸æƒ…å†µä¸‹è®¤è¯å®Œæ¯•åçš„æ‰€æœ‰ LDAP æµé‡å‡å—ç­¾åçš„ä¿æŠ¤ã€‚&lt;/p>
&lt;p>å¯ä»¥å‘ç° SMB ä¸ LDAP çš„åŒºåˆ«ï¼ŒSMB çš„ç­¾ååå•†æ˜¯å‘ç”Ÿåœ¨ SMB åè®®ä¸Šçš„ï¼Œè€Œ LDAP çš„ç­¾ååå•†åˆ™æ˜¯å‘ç”Ÿåœ¨ NTLM è®¤è¯æ—¶çš„ï¼Œé‚£æ˜¯å¦æ„å‘³ç€åªè¦æ”»å‡»è€…å°† Negotiate Sign è®¾ç½®ä¸º False å³å¯ç»•è¿‡ç­¾åï¼Ÿå¯æƒœçš„æ˜¯ï¼ŒNTLM ä¹Ÿæœ‰è‡ªå·±çš„æ¶ˆæ¯å®Œæ•´æ€§éªŒè¯æœºåˆ¶ï¼Œå³åæ–‡è¦ä»‹ç»çš„ MICã€‚&lt;/p>
&lt;h2 id="mic">MIC&lt;/h2>
&lt;p>MICï¼ˆMessage Integrity Codeï¼‰çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ï¼Œå³ä»å®¢æˆ·ç«¯å‘å‡ºå»æ˜¯ä»€ä¹ˆæ•°æ®å°±åº”è¯¥åœ¨æœåŠ¡ç«¯æ”¶åˆ°ä»€ä¹ˆæ•°æ®ï¼Œå®ƒåªåŒ…å«åœ¨ NTLM è®¤è¯æµç¨‹ä¸­çš„æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆAUTHENTICATEï¼‰ä¸­è¢«å‘å‡ºï¼Œç®—æ³•å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">HMAC_MD5(Session key, NEGOTIATE_MESSAGE + CHALLENGE_MESSAGE + AUTHENTICATE_MESSAGE)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±äº Session Key æ˜¯ç”±ç”¨æˆ·çš„ Hash æ‰€åŠ å¯†å¾—åˆ°çš„ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æ”»å‡»è€…æ²¡æœ‰åŠæ³•é‡æ–°è®¡ç®— MICï¼Œè€Œ MIC ä¸­åŒ…å«äº†ä¸‰æ¡æ¶ˆæ¯ï¼Œè¿™ä¹Ÿæ„å‘³ç€æ”»å‡»è€…æ²¡æœ‰åŠæ³•ä¿®æ”¹å‰ä¸¤æ¡æ¶ˆæ¯ï¼Œå› ä¸ºè¿™å°†å¯¼è‡´æœåŠ¡ç«¯ç®—å‡ºæ¥çš„ MIC æ— æ³•æ­£ç¡®æ ¡éªŒã€‚&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0bteo7rtyj21c00u0n5f.jpg"
loading="lazy"
alt="image-20220316164318066"
>&lt;/p>
&lt;p>ç”±äº MIC æ˜¯å¯é€‰çš„ï¼Œå› æ­¤åœ¨è½¬å‘æ•°æ®åŒ…çš„è¿‡ç¨‹ä¸­å¯ä»¥å°† MIC åˆ é™¤ï¼Œä½†è¿™æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºåœ¨ AUTHENTICATE æ¶ˆæ¯ä¸­è¿˜å­˜åœ¨ä¸€ä¸ª msAvFlagsï¼Œç”¨äºå‘ŠçŸ¥æœåŠ¡å™¨æ˜¯å¦è¦æ ¡éªŒ MICï¼Œå½“ msAvFlags ä¸º &lt;strong>0x00000002&lt;/strong> ä¸”æœåŠ¡å™¨æœªæ”¶åˆ° MIC æ—¶ï¼Œæ­¤æ¬¡è®¤è¯å°†è¢«åˆ¤å®šä¸ºå¤±è´¥ï¼š&lt;/p>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0bthj2n0zj21c00u07br.jpg"
loading="lazy"
alt="image-20220316164602560"
>&lt;/p>
&lt;p>é—æ†¾çš„æ˜¯ï¼Œæ”»å‡»è€…æ— æ³•å°†æ­¤ Flag è®¾ä¸º &lt;strong>0x00000000&lt;/strong> ä»¥ç»•è¿‡ MICï¼Œè¿™æ˜¯ç”±äº Flag å‚ä¸äº†è®¡ç®— NTProofStr çš„è¿‡ç¨‹ï¼Œå®ƒä¹Ÿæ˜¯æ•´ä¸ªåŠ å¯†å­—ç¬¦ä¸²ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å¦‚æœä¿®æ”¹äº†æ­¤ Flagï¼Œåˆ™æœ€ç»ˆæœåŠ¡ç«¯å°†æ— æ³•æ­£ç¡®éªŒè¯ NTProofStrï¼ŒåŒæ ·å°†å¯¼è‡´è®¤è¯å¤±è´¥ã€‚&lt;/p>
&lt;p>MIC ä¿æŠ¤äº†ä¸‰æ¡æ¶ˆæ¯çš„å®Œæ•´æ€§ï¼Œè€Œ msAvFlagsï¼ˆ&lt;strong>0x00000002&lt;/strong>ï¼‰åˆ™ä¿è¯äº† MIC çš„å­˜åœ¨ï¼Œæ­¤æ—¶ç”±äºæ”»å‡»è€…ä¸çŸ¥é“è®¤è¯ç”¨æˆ·çš„ NTLM-Hashï¼Œå› æ­¤ä»–ä»€ä¹ˆä¹Ÿåšä¸äº†ã€‚&lt;/p>
&lt;h3 id="cve-2019-1040">CVE-2019-1040&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.crowdstrike.com/" target="_blank" rel="noopener"
>Preempt&lt;/a> å›¢é˜Ÿå‘ç°äº†ä¸€ä¸ªç”¨äºç»•è¿‡ MIC æ ¡éªŒæœºåˆ¶çš„æ¼æ´ï¼Œç¼–å·ä¸º CVE-2019-1040ï¼Œä¹Ÿè¢«ç§°ä¸º Drop the MICï¼Œæ­¤æ¼æ´å·²ç»è¢«é›†æˆäº impacket ä¸­ï¼Œåªéœ€è¦å†è°ƒç”¨ ntlmrelayx æ—¶æ·»åŠ ä¸€ä¸ª &amp;ndash;remove-mic å‚æ•°å³å¯ä½¿ç”¨ï¼Œå…·ä½“è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">serverConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">remove_mic&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">authMessage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">NTLMAuthChallengeResponse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">authMessage&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fromString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">authenticateMessageBlob&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;flags&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_SIGN&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_SIGN&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;flags&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_SIGN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;flags&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_ALWAYS_SIGN&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_ALWAYS_SIGN&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;flags&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_ALWAYS_SIGN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;flags&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_KEY_EXCH&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_KEY_EXCH&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;flags&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_KEY_EXCH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;flags&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_VERSION&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_VERSION&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;flags&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="n">NTLMSSP_NEGOTIATE_VERSION&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;MIC&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;MICLen&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;Version&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">authMessage&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;VersionLen&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡ç½®ç©ºï¼ˆç½®é›¶ï¼‰çš„æ–¹å¼åˆ é™¤äº† NTLM_AUTHENTICATE æ¶ˆæ¯ä¸­çš„ MICã€MICLenã€Versionã€VersionLen å­—æ®µï¼Œæ­¤æ—¶å³å¯æˆåŠŸçš„ç»•è¿‡ æœåŠ¡ç«¯å¯¹äº MIC çš„æ ¡éªŒã€‚&lt;/p>
&lt;p>é€šè¿‡åŒæ ·çš„æ–¹å¼åˆ é™¤ï¼ˆç½®é›¶ï¼‰äº† NTLM_NEGOTIATE æ¶ˆæ¯ä¸­çš„ NTLMSSP_NEGOTIATE_ALWAYS_SIGNã€NTLMSSP_NEGOTIATE_SIGN å’Œ NTLM_AUTHENTICATE æ¶ˆæ¯ä¸­çš„ NTLMSSP_NEGOTIATE_ALWAYS_SIGNã€NTLMSSP_NEGOTIATE_SIGNã€NEGOTIATE_KEY_EXCHANGEã€NEGOTIATE_VERSION å­—æ®µï¼Œ&lt;strong>ç”±äºæ²¡æœ‰äº† MICï¼ŒæœåŠ¡ç«¯ä¸ä¼šå¯¹ä¸‰æ¡æ¶ˆæ¯æ˜¯å¦è¢«ç¯¡æ”¹è¿‡è¿›è¡ŒéªŒè¯ï¼Œä»è€Œç»•è¿‡ LDAP ç­¾åå®ç° relay to LDAPã€‚&lt;/strong>&lt;/p>
&lt;h2 id="epa">EPA&lt;/h2>
&lt;p>&lt;strong>ä¸ºäº†å¯¹æŠ—è·¨åè®® Relay ä½¿ NTLM Relay çš„å±å®³é™çº§&lt;/strong>ï¼Œå¾®è½¯å¼•å…¥äº†è¢«ç§°ä¸º EPA çš„ä¿æŠ¤æªæ–½ï¼Œè¿™ç§ä¿æŠ¤çš„åŸç†æ˜¯å°†èº«ä»½éªŒè¯å±‚ä¸æ­£åœ¨ä½¿ç”¨çš„åè®®ç»‘å®šåœ¨ä¸€èµ·ï¼Œç”šè‡³ä¸å­˜åœ¨çš„ TLS å±‚ç»‘å®šåœ¨ä¸€èµ·(ä¾‹å¦‚ LDAPS æˆ– HTTPS)ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ&lt;strong>å®ƒå°†åœ¨æœ€åä¸€æ¡ AUTHENTICATE æ¶ˆæ¯ä¸­æ”¾ç½®ä¸€æ¡ä¿¡æ¯ï¼Œæ”»å‡»è€…æ— æ³•ä¿®æ”¹å®ƒï¼Œæ­¤ä¿¡æ¯æŒ‡æ˜äº†æœ¬æ¬¡è°ƒç”¨çš„æœåŠ¡ï¼ˆSMBã€HTTPã€LDAPï¼‰ä»¥åŠå¯èƒ½åŒ…å«çš„è¯ä¹¦ç­‰å…¶å®ƒä¿¡æ¯ï¼ŒEPA é€šè¿‡æœåŠ¡ç»‘å®šå’Œ TLS ç»‘å®šä¸¤ç§æ–¹å¼é˜²å¾¡è·¨åè®® Relayã€‚&lt;/strong>&lt;/p>
&lt;h3 id="service-binding">Service Binding&lt;/h3>
&lt;p>&lt;img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0buq49fvuj21c00u048e.jpg"
loading="lazy"
alt="image-20220316172854322"
>&lt;/p>
&lt;p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒClient åœ¨ AUTHENTICATE æ¶ˆæ¯çš„ Response ä¸­åŠ å…¥äº† Target Name è¿™ä¹ˆä¸€ä¸ªå±æ€§ï¼Œå…¶ä¸­åŒ…å«äº† Client æƒ³è¦è°ƒç”¨çš„æœåŠ¡ä»¥åŠå¯¹åº”çš„ Client HostNameï¼Œå®ƒä¹Ÿå‚ä¸äº† NTProofStr çš„åŠ å¯†ï¼ˆå¯ä»¥ç†è§£ä¸ºå—åˆ° NTProofStr çš„ä¿æŠ¤ï¼‰ï¼Œå› æ­¤æ”»å‡»è€…æ— æ³•ä¿®æ”¹è¿™ä¸ªå±æ€§ã€‚&lt;/p>
&lt;p>å› æ­¤å¦‚æœæ”»å‡»è€…æƒ³è°ƒç”¨çš„æœåŠ¡æ”¶åˆ°äº†æ­¤æ¶ˆæ¯ï¼Œå¹¶ä¸”å®ƒå‘ç°äº†è‡ªèº«æä¾›çš„æœåŠ¡ä¸ AUTHENTICATE æ¶ˆæ¯ä¸­çš„ä¸åŒï¼Œé‚£ä¹ˆå°±ä¼šæ‹’ç»æä¾›æœåŠ¡ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒServer è¿˜å°†æ£€æŸ¥æ­¤æ¬¡æœåŠ¡è°ƒç”¨çš„ IP ä¸å±æ€§ä¸­æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åŒæ ·ä¼šæ‹’ç»æä¾›æœåŠ¡ï¼Œ&lt;strong>å¹¸è¿çš„æ˜¯ç›®å‰ EPA å¹¶ä¸æ˜¯ä½œä¸ºé»˜è®¤æƒ…å†µè¢«ä½¿ç”¨ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨è¿™ç§ä¿æŠ¤æªæ–½éœ€è¦æ‰‹åŠ¨è®¾ç½®ï¼Œå‚è€ƒ KB5005413ã€‚&lt;/strong>&lt;/p>
&lt;h3 id="tls-binding">TLS Binding&lt;/h3>
&lt;p>å¦‚æœå®¢æˆ·ç«¯å¸Œæœ›ä¸å°è£…åœ¨ TLS ä¸­çš„åè®®å¦‚ HTTPSã€LDAPS å»ºç«‹ä¼šè¯ï¼Œé‚£ä¹ˆå®ƒå°†è®¡ç®—æœåŠ¡ç«¯çš„è¯ä¹¦ Hashï¼Œå¹¶å°†æ­¤ Hash å­˜æ”¾åœ¨ Response ä¸­ï¼Œæ”»å‡»è€…æ— æ³•ä¿®æ”¹æ­¤å±æ€§ï¼Œå› æ­¤å½“æ”»å‡»è€…å°è¯•è¿›è¡Œ relay æ”»å‡»æ—¶ï¼Œ&lt;strong>æœåŠ¡ç«¯å‘ç° Response ä¸­çš„ Hash ä¸è‡ªèº«ä¸ç¬¦ï¼ˆå¦‚ HTTPS relay LDAPSï¼‰ï¼Œæˆ–æ˜¯æœåŠ¡ç«¯æ²¡æœ‰ä½¿ç”¨ TLSï¼ˆLDAPã€SMBï¼‰å´åœ¨ Response ä¸­å‘ç°äº† è¯ä¹¦ Hashï¼ˆSMB relay LDAPSã€SMB relay HTTPS &amp;hellip;ï¼‰ï¼Œåœ¨é‡åˆ°è¿™ä¸¤ç§æƒ…å†µæ—¶æœåŠ¡ç«¯éƒ½å°†æ‹’ç»æä¾›æœåŠ¡ã€‚&lt;/strong>&lt;/p>
&lt;h3 id="epa-bypass">EPA &amp;ldquo;Bypass&amp;rdquo;&lt;/h3>
&lt;p>ç½‘ä¸Šç›®å‰æµä¼ äº†ä¸¤ç¯‡æ–‡ç« ç”¨äºä»‹ç»å¦‚ä½•ç»•è¿‡ EPA çš„ï¼Œä¸€ç¯‡æ˜¯ &lt;a class="link" href="https://www.geekby.site/2020/05/ntlm-%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB/#5-epa-bypass" target="_blank" rel="noopener"
>geekby&lt;/a> å¦ä¸€ç¯‡åˆ™æ˜¯ &lt;a class="link" href="https://www.crowdstrike.com/blog/bypass-epa-ntlm-attacks-wia/" target="_blank" rel="noopener"
>bypass-epa-ntlm-attacks-wia&lt;/a> ï¼Œè¯´å®è¯æˆ‘ä¸èƒ½ç†è§£ä¸ºä»€ä¹ˆè¿™è¢«ç§°ä¸º Bypassï¼Œå› ä¸ºè¿™ç§ Bypass æ–¹å¼éœ€è¦æ”»å‡»è€…æ‹¥æœ‰ç”¨æˆ·å“ˆå¸Œä¸ºå‰æçš„ï¼Œä½†å¦‚æœæˆ‘æœ‰ç”¨æˆ·å“ˆå¸Œäº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨ NTLM Relay å‘¢ï¼Ÿä¸è¿‡æˆ‘å€’æ˜¯æœåˆ°äº†ä¸€ä¸ª CVE-2020-17162ï¼Œå…³äºè¿™ä¸ªæ¼æ´ç½‘ä¸Šè¿˜æ²¡æœ‰ä»»ä½•ç»†èŠ‚ã€‚&lt;/p>
&lt;blockquote>
&lt;p>It is a bypass of Extended Protection for Authentication(EPA) where Service Principle Name could allow Windows store UAP applications to elevate privileges.&lt;/p>
&lt;/blockquote>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä¸Šé¢è®°å½•äº†èƒ½å¤Ÿé˜²å¾¡ NTLM Relay çš„å››ç§æ–¹å¼ï¼Œå…¶ä¸­ ms08-068 é˜»æ­¢äº†æ”»å‡»è€… Relay To Self çš„æ“ä½œï¼Œè€Œå‰©ä½™ä¸‰ä¸ªé˜²å¾¡å‡æ˜¯ç”¨æ¥é˜²å¾¡ Relay To Otherï¼ˆOr Protocolï¼‰çš„æ“ä½œï¼ŒEPA è¾ƒä¹‹ç­¾åæ¥è¯´é˜²å¾¡çš„æ›´åŠ å…¨é¢ä¸€äº›ï¼Œå› æ­¤å¦‚æœæƒ³çœŸæ­£åšåˆ°å®Œç¾é˜²å¾¡ NTLM Relayï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨ EPA ä½œä¸ºé˜²å¾¡æœºåˆ¶ï¼Œä»¥åŠä¸€å¤„ä¸çŸ¥é“æ˜¯å¦å·²ç»å®æ–½çš„å®‰å…¨é€šå‘Šã€‚&lt;/p>
&lt;blockquote>
&lt;p>å¾®è½¯äº 2019-09-11 æ—¥å‘å¸ƒç›¸å…³é€šå‘Šç§°å¾®è½¯è®¡åˆ’äº 2020 å¹´ 1 æœˆå‘å¸ƒå®‰å…¨æ›´æ–°ã€‚ä¸ºäº†æå‡åŸŸæ§åˆ¶å™¨çš„å®‰å…¨æ€§ï¼Œè¯¥å®‰å…¨æ›´æ–°å°†å¼ºåˆ¶å¼€å¯æ‰€æœ‰åŸŸæ§åˆ¶å™¨ä¸Š LDAP channel binding ä¸ LDAP signing åŠŸèƒ½ã€‚&lt;/p>
&lt;/blockquote>
&lt;h1 id="reference">Reference&lt;/h1>
&lt;ul>
&lt;li>&lt;a class="link" href="https://docs.microsoft.com/zh-cn/openspecs/windows_protocols/ms-nlmp/b38c36ed-2804-4868-a9ff-8dd3182128e4" target="_blank" rel="noopener"
>NT LAN Manager (NTLM) Authentication Protocol&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://shenaniganslabs.io/2019/11/12/Ghost-Potato.html" target="_blank" rel="noopener"
>Ghost-Potato&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://en.hackndo.com/ntlm-relay/" target="_blank" rel="noopener"
>NTLM Relay&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>